<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SmartSelective</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Newsreader:opsz,wght@6..72,400;6..72,600;6..72,700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
:root{--navy:#0f172a;--navy-l:#1e293b;--blue:#2563eb;--blue-l:#3b82f6;--blue-p:#dbeafe;--blue-g:#eff6ff;--gold:#d97706;--gold-l:#f59e0b;--gold-p:#fef3c7;--green:#059669;--green-l:#10b981;--green-p:#d1fae5;--red:#dc2626;--red-l:#ef4444;--red-p:#fee2e2;--purple:#7c3aed;--purple-p:#ede9fe;--bg:#f8fafc;--card:#fff;--tx:#0f172a;--tx2:#475569;--tx3:#94a3b8;--bdr:#e2e8f0;--bdr-l:#f1f5f9;--sh-s:0 1px 2px rgba(0,0,0,.04);--sh-m:0 4px 16px rgba(0,0,0,.06);--sh-l:0 12px 40px rgba(0,0,0,.1);--r:10px;--rl:14px}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--tx);line-height:1.55}h1,h2,h3{font-family:'Newsreader',serif}
.hdr{background:var(--card);border-bottom:1px solid var(--bdr);padding:.75rem 0;position:sticky;top:0;z-index:200}.hdr-i{max-width:1400px;margin:0 auto;padding:0 1.5rem;display:flex;justify-content:space-between;align-items:center}.logo{font-family:'Newsreader',serif;font-size:1.35rem;font-weight:700;color:var(--navy);text-decoration:none}.logo em{font-style:normal;color:var(--blue)}.hdr-r{display:flex;align-items:center;gap:.75rem}.hdr-av{width:32px;height:32px;border-radius:50%;background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.75rem}.hdr-em{font-size:.8rem;color:var(--tx2)}.hdr-ab{font-size:.65rem;font-weight:700;color:var(--gold);background:var(--gold-p);padding:.15rem .5rem;border-radius:20px;text-transform:uppercase;letter-spacing:.5px}.btn-lo{font-family:inherit;font-size:.75rem;font-weight:600;color:var(--red);background:none;border:1px solid var(--red-p);padding:.4rem .75rem;border-radius:6px;cursor:pointer;transition:.15s}.btn-lo:hover{background:var(--red);color:#fff}
.shell{max-width:1400px;margin:0 auto;padding:1.25rem 1.5rem;display:grid;grid-template-columns:200px 1fr;gap:1.25rem}
.side{position:sticky;top:72px;height:fit-content}.side nav{display:flex;flex-direction:column;gap:2px}.side a{display:flex;align-items:center;gap:.6rem;padding:.6rem .75rem;font-size:.8125rem;font-weight:500;color:var(--tx2);text-decoration:none;border-radius:var(--r);transition:.12s}.side a:hover{background:var(--blue-g);color:var(--blue)}.side a.on{background:var(--blue);color:#fff}.side .ns{height:1px;background:var(--bdr);margin:.5rem 0}
.main{display:flex;flex-direction:column;gap:1.25rem;min-width:0}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--rl);padding:1.25rem 1.5rem}.ct{font-size:1.05rem;font-weight:600;margin-bottom:.75rem}
.wel{background:linear-gradient(135deg,var(--navy),var(--navy-l));color:#fff;padding:1.75rem 2rem;border-radius:var(--rl);position:relative;overflow:hidden;border:none}.wel::after{content:'';position:absolute;top:-40px;right:-20px;width:200px;height:200px;border-radius:50%;background:rgba(37,99,235,.15)}.wel h1{font-size:1.5rem;margin-bottom:.25rem;position:relative;z-index:1}.wel p{font-size:.875rem;opacity:.7;position:relative;z-index:1}
.wb{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem}.wbl{display:flex;align-items:center;gap:1rem}.wbb{background:var(--blue);color:#fff;font-size:.75rem;font-weight:700;padding:.3rem .75rem;border-radius:20px}.wbd{font-size:.8125rem;color:var(--tx2)}.wbp{font-size:.75rem;color:var(--gold);background:var(--gold-p);padding:.3rem .75rem;border-radius:20px;font-weight:600}.wbc{font-size:.75rem;color:var(--red);background:var(--red-p);padding:.3rem .75rem;border-radius:20px;font-weight:600}
.tg{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}.tc{background:var(--card);border:1px solid var(--bdr);border-radius:var(--rl);padding:1.25rem;transition:.2s;position:relative;overflow:hidden}.tc:hover{box-shadow:var(--sh-m);transform:translateY(-2px)}.ts{position:absolute;top:0;left:0;right:0;height:3px}.th{display:flex;justify-content:space-between;align-items:start;margin:.25rem 0 .75rem}.tt{font-weight:600;font-size:.9375rem}.ti{font-size:1.5rem}.tm{font-size:.75rem;color:var(--tx2);display:flex;flex-direction:column;gap:.35rem;margin-bottom:.75rem}.tr{display:flex;justify-content:space-between}.tr b{font-weight:600;color:var(--tx)}
.bd{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .5rem;border-radius:20px;font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px}.bd-n{background:var(--red-p);color:var(--red)}.bd-p{background:var(--gold-p);color:var(--gold)}.bd-u{background:var(--purple-p);color:var(--purple)}.bd-d{background:var(--green-p);color:var(--green)}.bd-l{background:var(--bdr-l);color:var(--tx3)}
.tb{width:100%;padding:.55rem;border:none;border-radius:8px;font-family:inherit;font-size:.8125rem;font-weight:600;cursor:pointer;transition:.15s;margin-top:.5rem}.tb-s{background:var(--blue);color:#fff}.tb-s:hover{background:var(--navy)}.tb-r{background:var(--gold);color:#fff}.tb-r:hover{background:#b45309}.tb-v{background:var(--green);color:#fff}.tb-v:hover{background:#047857}.tb-l{background:var(--bdr);color:var(--tx3);cursor:not-allowed}
.sr{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}.st{text-align:center}.sv{font-family:'Newsreader',serif;font-size:1.65rem;font-weight:700;color:var(--blue);line-height:1.1}.sl{font-size:.75rem;color:var(--tx3);margin-top:.2rem}
.c2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.cw{position:relative;height:200px}.nd{display:flex;align-items:center;justify-content:center;height:200px;color:var(--tx3);font-size:.8125rem}
.rtbl{width:100%;border-collapse:collapse}.rtbl th{text-align:left;padding:.6rem .75rem;font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx3);border-bottom:2px solid var(--bdr)}.rtbl td{padding:.6rem .75rem;font-size:.8125rem;border-bottom:1px solid var(--bdr-l);color:var(--tx2)}.rtbl tr:hover td{background:var(--blue-g)}.pill{display:inline-block;padding:.15rem .5rem;border-radius:20px;font-size:.75rem;font-weight:600}.pill-h{background:var(--green-p);color:var(--green)}.pill-m{background:var(--gold-p);color:var(--gold)}.pill-l{background:var(--red-p);color:var(--red)}
.mo-bg{display:none;position:fixed;inset:0;background:rgba(15,23,42,.55);backdrop-filter:blur(4px);z-index:500;justify-content:center;align-items:center;padding:1rem}.mo-bg.on{display:flex}.mo{background:var(--card);border-radius:var(--rl);width:100%;max-width:780px;max-height:92vh;display:flex;flex-direction:column;box-shadow:var(--sh-l);position:relative}.mh{padding:1rem 1.5rem;border-bottom:1px solid var(--bdr);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}.mh h2{font-size:1.1rem}.mta{display:flex;align-items:center;gap:.75rem}.mt{font-family:'Plus Jakarta Sans',monospace;font-size:1.35rem;font-weight:700;color:var(--blue);min-width:70px;text-align:center}.mt.w{color:var(--red);animation:pu .8s infinite}@keyframes pu{0%,100%{opacity:1}50%{opacity:.5}}.mb-i{padding:.4rem .75rem;border-radius:6px;border:none;font-family:inherit;font-size:.75rem;font-weight:600;cursor:pointer;transition:.15s}.mb-p{background:var(--gold);color:#fff}.mb-p.pd{background:var(--green)}.mb-c{background:none;color:var(--tx3);border:1px solid var(--bdr)}.mb-c:hover{background:var(--bdr-l)}.mbd{padding:1.5rem;overflow-y:auto;flex:1}
.po{background:var(--gold-p);border:1px solid #fde68a;border-radius:var(--r);padding:.875rem 1rem;margin-bottom:1.25rem;display:flex;gap:.6rem;align-items:start}.poi{font-size:1.1rem;flex-shrink:0}.pot{font-size:.75rem;color:#92400e;line-height:1.5}.pot strong{color:#78350f}
.pov{display:none;position:absolute;inset:0;background:rgba(255,255,255,.97);z-index:10;flex-direction:column;justify-content:center;align-items:center;gap:1rem;border-radius:var(--rl)}.pov.on{display:flex}.pov h3{font-size:1.25rem}.pov p{color:var(--tx2);font-size:.875rem}.pvt{font-family:'Plus Jakarta Sans',monospace;font-size:2rem;font-weight:700;color:var(--blue)}.brn{padding:.7rem 2rem;background:var(--blue);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:.9375rem;font-weight:700;cursor:pointer}.brn:hover{background:var(--navy)}
.qp{display:flex;align-items:center;gap:.75rem;margin-bottom:1.25rem}.qc{font-size:.8125rem;color:var(--tx2);white-space:nowrap}.qbt{flex:1;height:5px;background:var(--bdr);border-radius:3px;overflow:hidden}.qbf{height:100%;background:var(--blue);border-radius:3px;transition:width .3s}
.pas{background:var(--bg);border:1px solid var(--bdr);border-radius:var(--r);padding:1rem 1.25rem;margin-bottom:1rem;font-size:.875rem;line-height:1.7;max-height:220px;overflow-y:auto}.qt{font-size:.9375rem;font-weight:500;margin-bottom:.875rem}.ops{display:flex;flex-direction:column;gap:.4rem}.op{display:flex;align-items:center;gap:.6rem;padding:.7rem 1rem;background:var(--bg);border:2px solid var(--bdr);border-radius:8px;cursor:pointer;transition:.12s;font-size:.875rem}.op:hover{border-color:var(--blue-l);background:var(--blue-g)}.op.se{border-color:var(--blue);background:var(--blue-g)}.op.co{border-color:var(--green);background:var(--green-p)}.op.wr{border-color:var(--red);background:var(--red-p)}.ol{width:26px;height:26px;border-radius:50%;background:#fff;border:2px solid var(--bdr);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.75rem;color:var(--tx2);flex-shrink:0}.op.se .ol{background:var(--blue);border-color:var(--blue);color:#fff}
.qn{display:flex;justify-content:space-between;margin-top:1.25rem;padding-top:1rem;border-top:1px solid var(--bdr)}.qnb{padding:.5rem 1.25rem;border-radius:8px;border:none;font-family:inherit;font-size:.8125rem;font-weight:600;cursor:pointer;transition:.15s}.qnp{background:var(--bdr-l);color:var(--tx2)}.qnp:hover{background:var(--bdr)}.qnn{background:var(--blue);color:#fff}.qnn:hover{background:var(--navy)}.qns{background:var(--green);color:#fff}.qns:hover{background:#047857}.qnb:disabled{opacity:.4;cursor:not-allowed}
.rc{text-align:center;padding:1.5rem 0}.rci{width:120px;height:120px;border-radius:50%;border:6px solid var(--blue);display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto 1.25rem}.rn{font-family:'Newsreader',serif;font-size:2.25rem;font-weight:700;color:var(--blue);line-height:1}.rp{font-size:.65rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px}.rg{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin:1.25rem 0}.ri{background:var(--bg);padding:.75rem;border-radius:8px}.rv{font-size:1.1rem;font-weight:700;color:var(--tx)}.rlb{font-size:.65rem;color:var(--tx3);margin-top:.15rem}.rbs{display:flex;gap:.75rem;justify-content:center;margin-top:1.5rem}.rb{padding:.55rem 1.25rem;border-radius:8px;border:none;font-family:inherit;font-size:.8125rem;font-weight:600;cursor:pointer;transition:.15s}.rb1{background:var(--blue);color:#fff}.rb2{background:var(--bdr-l);color:var(--tx2)}.rb3{background:var(--purple);color:#fff}
.cfb{display:none;position:fixed;inset:0;background:rgba(15,23,42,.4);z-index:600;justify-content:center;align-items:center}.cfb.on{display:flex}.cf{background:#fff;border-radius:var(--rl);padding:1.75rem;max-width:380px;width:90%;text-align:center;box-shadow:var(--sh-l)}.cf h3{margin-bottom:.5rem}.cf p{color:var(--tx2);font-size:.8125rem;margin-bottom:1.25rem;line-height:1.5}.cfs{display:flex;gap:.5rem;justify-content:center}.cfn{padding:.5rem 1.25rem;border-radius:8px;border:none;font-family:inherit;font-weight:600;font-size:.8125rem;cursor:pointer}.cfy{background:var(--red);color:#fff}.cfnn{background:var(--bdr-l);color:var(--tx2)}
.toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--navy);color:#fff;padding:.75rem 1.25rem;border-radius:8px;font-size:.8125rem;box-shadow:var(--sh-l);transform:translateY(120%);opacity:0;transition:.3s;z-index:700;max-width:380px}.toast.on{transform:translateY(0);opacity:1}.toast.tw{background:#92400e}
.afr{display:grid;grid-template-columns:140px 1fr;gap:.75rem;align-items:start;margin-bottom:.75rem}.afl{font-size:.8125rem;font-weight:600;color:var(--tx);padding-top:.5rem}.afi,.afs,.aft{font-family:inherit;font-size:.8125rem;padding:.5rem .75rem;border:1px solid var(--bdr);border-radius:6px;width:100%}.aft{min-height:100px;resize:vertical;line-height:1.6}.afs{background:#fff}
.aqi{background:var(--bg);border:1px solid var(--bdr);border-radius:var(--r);padding:.875rem 1rem;margin-bottom:.5rem}.aqi h4{font-size:.8125rem;font-weight:600;margin-bottom:.35rem}.aqi p{font-size:.75rem;color:var(--tx2);line-height:1.5}.aqa{display:flex;gap:.35rem;margin-top:.5rem}.aqb{font-family:inherit;font-size:.7rem;font-weight:600;padding:.25rem .5rem;border-radius:4px;border:none;cursor:pointer}.aqd{background:var(--red-p);color:var(--red)}
.abtn{padding:.55rem 1.5rem;background:var(--blue);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:.8125rem;font-weight:600;cursor:pointer;transition:.15s}.abtn:hover{background:var(--navy)}.abtn-d{background:var(--red)}.abtn-g{background:var(--gold)}
.awi{display:flex;align-items:center;justify-content:space-between;padding:.625rem .875rem;border:1px solid var(--bdr);border-radius:8px;margin-bottom:.4rem;transition:.12s}.awi:hover{background:var(--blue-g)}.awl{display:flex;align-items:center;gap:.75rem}.awb{font-size:.7rem;font-weight:700;padding:.15rem .5rem;border-radius:20px}.awa{background:var(--green-p);color:var(--green)}.awu{background:var(--blue-p);color:var(--blue)}.awp{background:var(--bdr-l);color:var(--tx3)}
.rtag{display:inline-block;padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600;margin-bottom:.5rem}.rtag-c{background:var(--green-p);color:var(--green)}.rtag-w{background:var(--red-p);color:var(--red)}.expl{background:var(--blue-g);border:1px solid var(--blue-p);border-radius:var(--r);padding:.75rem 1rem;margin-top:.75rem;font-size:.8125rem;line-height:1.5;color:var(--tx2)}.expl strong{color:var(--blue)}
.atabs{display:flex;gap:2px;margin-bottom:1rem}.atab{padding:.5rem 1rem;background:var(--bdr-l);border:none;border-radius:8px 8px 0 0;font-family:inherit;font-size:.8125rem;font-weight:500;color:var(--tx2);cursor:pointer;transition:.12s}.atab.on{background:var(--card);color:var(--blue);border:1px solid var(--bdr);border-bottom:1px solid var(--card);font-weight:600}
@media(max-width:1024px){.c2{grid-template-columns:1fr}.sr{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.shell{grid-template-columns:1fr;padding:.75rem}.side{display:none}.tg{grid-template-columns:1fr}.sr{grid-template-columns:1fr 1fr}.rg{grid-template-columns:1fr}.wel{padding:1.25rem}.wel h1{font-size:1.2rem}.afr{grid-template-columns:1fr}}
@keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.an{animation:fu .35s ease forwards}.d1{animation-delay:.04s;opacity:0}.d2{animation-delay:.08s;opacity:0}.d3{animation-delay:.12s;opacity:0}.d4{animation-delay:.16s;opacity:0}.d5{animation-delay:.2s;opacity:0}
    </style>
</head>
<body>
<div id="loading" style="display:flex;justify-content:center;align-items:center;min-height:100vh;"><div style="text-align:center;"><div style="font-family:'Newsreader',serif;font-size:1.35rem;color:var(--navy);font-weight:700;">Smart<em style="font-style:normal;color:var(--blue);">Selective</em></div><div style="color:var(--tx3);font-size:.875rem;margin-top:.35rem;">Loading dashboard...</div></div></div>
<div id="app" style="display:none;">
<header class="hdr"><div class="hdr-i"><a href="/" class="logo">Smart<em>Selective</em></a><div class="hdr-r"><span class="hdr-ab" id="adBadge" style="display:none">Admin</span><div class="hdr-av" id="av">S</div><span class="hdr-em" id="em"></span><button class="btn-lo" id="logoutBtn">Log Out</button></div></div></header>
<div class="shell">
<aside class="side"><nav><a href="#" class="on" data-v="dash"><span>üìä</span> Dashboard</a><a href="#" data-v="results"><span>üìã</span> My Results</a><a href="#" data-v="history"><span>üìà</span> Practice History</a><div class="ns"></div><a href="#" data-v="admin" id="adNav" style="display:none"><span>üîß</span> Admin Panel</a><a href="#" data-v="settings"><span>‚öôÔ∏è</span> Settings</a></nav></aside>
<main class="main" id="ma"></main>
</div></div>
<div class="mo-bg" id="tModal"><div class="mo"><div class="mh"><h2 id="mTi">Test</h2><div class="mta"><div class="mt" id="mTm">30:00</div><button class="mb-i mb-p" id="mPa">‚è∏ Pause</button><button class="mb-i mb-c" id="mCl">‚úï</button></div></div><div class="mbd" id="mBd"></div><div class="pov" id="paOv"><h3>‚è∏ Test Paused</h3><p>Your progress is saved. Resume when you're ready.</p><div class="pvt" id="paTm">25:30</div><button class="brn" id="reBtn">‚ñ∂ Resume Test</button></div></div></div>
<div class="cfb" id="cfBg"><div class="cf"><h3 id="cfTi">Leave Test?</h3><p id="cfMs">Your progress will be saved.</p><div class="cfs"><button class="cfn cfnn" id="cfNo">Cancel</button><button class="cfn cfy" id="cfYe">Leave</button></div></div></div>
<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
'use strict';
var SB=window.supabase.createClient('https://qeowtqkfotypsrkfaniw.supabase.co','sb_publishable_Byg3sZUa0AzxVuyPEhY8GQ_3GGOidrj');
var ADMINS=['tazza@machplastech.com.au'];
var SUBJ=[
{id:'reading',title:'Reading Comprehension',icon:'üìñ',time:35,color:'#6366f1',stripe:'background:#6366f1'},
{id:'math',title:'Mathematics',icon:'üî¢',time:30,color:'#f59e0b',stripe:'background:#f59e0b'},
{id:'verbal',title:'Verbal Reasoning',icon:'üí¨',time:30,color:'#10b981',stripe:'background:#10b981'},
{id:'quantitative',title:'Quantitative Reasoning',icon:'üßÆ',time:30,color:'#ef4444',stripe:'background:#ef4444'}
];

var S={user:null,isAdmin:false,wTests:ls('ss_wt')||{},prog:ls('ss_ip')||{},res:ls('ss_rs')||[],cur:null,tInt:null,paused:false,adView:'manage'};
function sv(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
function ls(k){try{var d=localStorage.getItem(k);return d?JSON.parse(d):null}catch(e){return null}}

function wk(){var now=new Date(),ep=new Date(2025,0,6),df=Math.floor((now-ep)/864e5),wn=Math.floor(df/7)+1;if(wn<1)wn=1;
var ws=new Date(ep.getTime()+(wn-1)*7*864e5),to=new Date(ws.getTime()+864e5),tc=new Date(ws.getTime()+6*864e5+86399000);
var dy=now.getDay(),io=now>=to&&now<=tc,dl=0;if(io){dl=dy===0?0:7-dy}
var f={month:'short',day:'numeric'},yr=now.getFullYear();
return{n:wn,l:'Week '+wn,k:'w'+wn+'_'+yr,dates:ws.toLocaleDateString('en-US',f)+' ‚Äì '+new Date(ws.getTime()+6*864e5).toLocaleDateString('en-US',f)+', '+yr,open:io,dl:dl}}

function fmt(s){var m=Math.floor(s/60),sc=s%60;return(m<10?'0':'')+m+':'+(sc<10?'0':'')+sc}
function toast(m,t){var e=document.getElementById('toast');e.textContent=m;e.className='toast'+(t==='w'?' tw':'');setTimeout(function(){e.classList.add('on')},10);setTimeout(function(){e.classList.remove('on')},4000)}
function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}

var cv='dash';
function sw(v){cv=v;document.querySelectorAll('.side a').forEach(function(a){a.classList.toggle('on',a.getAttribute('data-v')===v)});rv()}

function rv(){var m=document.getElementById('ma');switch(cv){case'dash':rDash(m);break;case'results':rRes(m);break;case'history':rHist(m);break;case'admin':rAdmin(m);break;case'settings':rSet(m);break}}

// ===== DASHBOARD =====
function rDash(el){
var w=wk(),nm=S.user?S.user.email.split('@')[0]:'Student';
var h='<div class="wel an"><h1>Welcome back, '+esc(nm)+'!</h1><p>Ready to continue your preparation for VIC Selective Schools?</p></div>';
var pol=w.open?'<span class="wbp">‚è∞ Tue‚ÄìSun 23:59 | '+(w.dl===0?'Last day!':w.dl+'d left')+'</span>':'<span class="wbc">üîí Opens Tuesday</span>';
h+='<div class="card wb an d1"><div class="wbl"><span class="wbb">'+w.l+'</span><span class="wbd">'+w.dates+'</span></div>'+pol+'</div>';
h+='<div class="an d2"><div class="ct">This Week\'s Tests</div><div class="tg">'+rCards(w)+'</div></div>';
h+='<div class="an d3"><div class="ct">Your Progress</div>'+rStats(w)+'</div>';
h+='<div class="c2 an d4"><div class="card"><div class="ct">Score Trend</div><div class="cw"><canvas id="cL"></canvas><div class="nd" id="nL">Complete tests to see trends</div></div></div><div class="card"><div class="ct">Subject Performance</div><div class="cw"><canvas id="cB"></canvas><div class="nd" id="nB">Complete tests to see breakdown</div></div></div></div>';
h+='<div class="card an d5"><div class="ct">Recent Results</div><div id="rr"></div></div>';
el.innerHTML=h;
setTimeout(function(){rLC('cL','nL');rBC('cB','nB');rRT('rr',8)},50);
}

function rCards(w){
var h='';
SUBJ.forEach(function(sj){
var wt=S.wTests[w.k],has=wt&&wt[sj.id]&&wt[sj.id].questions&&wt[sj.id].questions.length>0;
var res=S.res.find(function(r){return r.tid===sj.id&&r.wk===w.k});
var pr=S.prog[sj.id],itw=pr&&pr.wk===w.k;
var st,btn;
if(!w.open){st='<span class="bd bd-l">üîí Closed</span>';btn='<button class="tb tb-l" disabled>Opens Tuesday</button>';}
else if(!has){st='<span class="bd bd-l">‚è≥ Pending</span>';btn='<button class="tb tb-l" disabled>Not Available</button>';}
else if(res){st='<span class="bd bd-d">‚úì Done</span>';btn='<button class="tb tb-v" onclick="SS.vRes(\''+sj.id+'\',\''+w.k+'\')">View Result</button>';}
else if(itw&&pr.tl>0){st='<span class="bd bd-u">‚è∏ Paused</span>';btn='<button class="tb tb-r" onclick="SS.resume(\''+sj.id+'\')">Resume</button>';}
else{st='<span class="bd bd-n">New</span>';btn='<button class="tb tb-s" onclick="SS.start(\''+sj.id+'\')">Start Test</button>';}
var qc=has?wt[sj.id].questions.length+' items':'‚Äî';
h+='<div class="tc"><div class="ts" style="'+sj.stripe+'"></div><div class="th"><div class="tt">'+sj.title+'</div><div class="ti">'+sj.icon+'</div></div><div class="tm"><div class="tr"><span>Questions</span><b>'+qc+'</b></div><div class="tr"><span>Time</span><b>'+sj.time+' min</b></div><div class="tr"><span>Status</span>'+st+'</div></div>'+btn+'</div>';
});
return h;
}

function rStats(w){
var wr=S.res.filter(function(r){return r.wk===w.k}),c=wr.length;
var avg='‚Äî';if(c>0)avg=Math.round(wr.reduce(function(s,r){return s+r.pct},0)/c)+'%';
var sk=0,yr=new Date().getFullYear();for(var n=w.n;n>=1;n--){var wk2='w'+n+'_'+yr;if(S.res.filter(function(r){return r.wk===wk2}).length===4)sk++;else break;}
var dl=!w.open?'Closed':w.dl===0?'Last day!':w.dl+'d';
return'<div class="sr"><div class="card st"><div class="sv">'+c+'/4</div><div class="sl">Completed</div></div><div class="card st"><div class="sv">'+avg+'</div><div class="sl">Avg Score</div></div><div class="card st"><div class="sv">'+dl+'</div><div class="sl">Time Left</div></div><div class="card st"><div class="sv">'+sk+'</div><div class="sl">Streak</div></div></div>';
}

// ===== CHARTS =====
function rLC(ci,ni){var c=document.getElementById(ci),n=document.getElementById(ni);if(!c||!n)return;if(S.res.length===0){c.style.display='none';n.style.display='flex';return;}c.style.display='block';n.style.display='none';
var wm={};S.res.forEach(function(r){if(!wm[r.wk])wm[r.wk]=[];wm[r.wk].push(r.pct)});var ks=Object.keys(wm).sort().slice(-8);var d=ks.map(function(k){var a=wm[k];return Math.round(a.reduce(function(s,v){return s+v},0)/a.length)});
new Chart(c,{type:'line',data:{labels:ks.map(function(k){return k.replace('_','/').replace('w','W')}),datasets:[{data:d,borderColor:'#2563eb',backgroundColor:'rgba(37,99,235,.08)',fill:true,tension:.3,pointBackgroundColor:'#2563eb',pointRadius:4,borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{min:0,max:100,ticks:{callback:function(v){return v+'%'},font:{size:10}}},x:{ticks:{font:{size:10}}}}}});}

function rBC(ci,ni){var c=document.getElementById(ci),n=document.getElementById(ni);if(!c||!n)return;if(S.res.length===0){c.style.display='none';n.style.display='flex';return;}c.style.display='block';n.style.display='none';
var sm={};SUBJ.forEach(function(s){sm[s.id]=[]});S.res.forEach(function(r){if(sm[r.tid])sm[r.tid].push(r.pct)});
var lb=SUBJ.map(function(s){return s.title.split(' ')[0]}),d=SUBJ.map(function(s){var a=sm[s.id];return a.length?Math.round(a.reduce(function(x,y){return x+y},0)/a.length):0}),co=SUBJ.map(function(s){return s.color});
new Chart(c,{type:'bar',data:{labels:lb,datasets:[{data:d,backgroundColor:co.map(function(c){return c+'30'}),borderColor:co,borderWidth:2,borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{min:0,max:100,ticks:{callback:function(v){return v+'%'},font:{size:10}}},x:{ticks:{font:{size:10}}}}}});}

// ===== RESULTS TABLE =====
function rRT(ci,lim){var el=document.getElementById(ci);if(!el)return;var rc=S.res.slice().reverse().slice(0,lim||8);
if(rc.length===0){el.innerHTML='<div class="nd" style="height:100px">No completed tests yet.</div>';return;}
var h='<table class="rtbl"><thead><tr><th>Test</th><th>Week</th><th>Score</th><th>Correct</th><th>Time</th><th>Date</th></tr></thead><tbody>';
rc.forEach(function(r){var sj=SUBJ.find(function(s){return s.id===r.tid});var cl=r.pct>=80?'pill-h':r.pct>=50?'pill-m':'pill-l';
h+='<tr><td><b>'+(sj?sj.icon+' '+sj.title:r.tid)+'</b></td><td>'+r.wk.replace('w','W').replace('_','/')+'</td><td><span class="pill '+cl+'">'+r.pct+'%</span></td><td>'+r.cor+'/'+r.tot+'</td><td>'+(r.tu||'‚Äî')+'</td><td>'+new Date(r.at).toLocaleDateString('en-US',{month:'short',day:'numeric'})+'</td></tr>';});
h+='</tbody></table>';el.innerHTML=h;}

// ===== MY RESULTS =====
function rRes(el){el.innerHTML='<div class="wel an" style="background:linear-gradient(135deg,#065f46,#059669)"><h1>My Results</h1><p>All completed test results.</p></div><div class="card an d1" style="margin-top:1.25rem"><div class="ct">All Results</div><div id="art"></div></div>';setTimeout(function(){rRT('art',100)},30);}

// ===== HISTORY =====
function rHist(el){el.innerHTML='<div class="wel an" style="background:linear-gradient(135deg,#7c2d12,#c2410c)"><h1>Practice History</h1><p>Performance over time.</p></div><div class="c2 an d1" style="margin-top:1.25rem"><div class="card"><div class="ct">Weekly Scores</div><div class="cw"><canvas id="hL"></canvas><div class="nd" id="hLN">No data</div></div></div><div class="card"><div class="ct">Subject Averages</div><div class="cw"><canvas id="hB"></canvas><div class="nd" id="hBN">No data</div></div></div></div>';setTimeout(function(){rLC('hL','hLN');rBC('hB','hBN')},50);}

// ===== SETTINGS =====
function rSet(el){var e=S.user?S.user.email:'‚Äî',si=S.user?new Date(S.user.created_at).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}):'‚Äî';
el.innerHTML='<div class="wel an" style="background:linear-gradient(135deg,#4c1d95,#7c3aed)"><h1>Settings</h1><p>Manage your account.</p></div><div class="card an d1" style="margin-top:1.25rem"><div class="ct">Account</div><div class="tm" style="max-width:400px"><div class="tr"><span>Email</span><b>'+esc(e)+'</b></div><div class="tr"><span>Status</span><b><span class="bd bd-d">Active</span></b></div><div class="tr"><span>Since</span><b>'+si+'</b></div><div class="tr"><span>Role</span><b>'+(S.isAdmin?'Admin':'Student')+'</b></div></div></div><div class="card an d2" style="margin-top:1rem"><div class="ct">Data</div><p style="font-size:.8125rem;color:var(--tx2);margin-bottom:1rem">Export or clear test data.</p><div style="display:flex;gap:.5rem"><button class="abtn" onclick="SS.exp()">üì• Export</button><button class="abtn abtn-d" onclick="SS.clr()">üóë Clear All</button></div></div>';}

// ===== ADMIN =====
function rAdmin(el){if(!S.isAdmin){el.innerHTML='<div class="card"><p>Access denied.</p></div>';return;}
var w=wk(),h='<div class="wel an" style="background:linear-gradient(135deg,#78350f,#d97706)"><h1>Admin Panel</h1><p>Manage weekly test questions and answer keys.</p></div>';
h+='<div class="an d1" style="margin-top:1.25rem"><div class="atabs"><button class="atab'+(S.adView==='manage'?' on':'')+'" onclick="SS.atab(\'manage\')">üìÅ Manage</button><button class="atab'+(S.adView==='create'?' on':'')+'" onclick="SS.atab(\'create\')">‚ûï Create</button></div>';

if(S.adView==='manage'){
h+='<div class="card"><div class="ct">Week Overview</div>';
var yr=new Date().getFullYear();
for(var n=Math.max(1,w.n-2);n<=w.n+2;n++){var wk2='w'+n+'_'+yr,ic=n===w.n,ip=n<w.n;
var bc=ic?'awa':ip?'awp':'awu',bl=ic?'Current':ip?'Past':'Upcoming';
var td=S.wTests[wk2],ss=SUBJ.map(function(s){var ok=td&&td[s.id]&&td[s.id].questions&&td[s.id].questions.length>0;return s.icon+(ok?'‚úì':'‚úó')}).join('  ');
h+='<div class="awi"><div class="awl"><span class="awb '+bc+'">'+bl+'</span><span style="font-weight:600;font-size:.875rem">Week '+n+'</span></div><div style="font-size:.8125rem">'+ss+'</div></div>';}
h+='</div>';

h+='<div class="card" style="margin-top:1rem"><div class="ct">'+w.l+' Details</div>';
var wd=S.wTests[w.k];
SUBJ.forEach(function(sj){var d=wd&&wd[sj.id];
h+='<div style="margin-bottom:.75rem"><div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.35rem"><span>'+sj.icon+'</span><b style="font-size:.875rem">'+sj.title+'</b>';
h+=d&&d.questions&&d.questions.length>0?' <span class="bd bd-d">'+d.questions.length+'Q</span>':' <span class="bd bd-n">Empty</span>';h+='</div>';
if(d&&d.questions){d.questions.forEach(function(q,i){
h+='<div class="aqi"><h4>Q'+(i+1)+': '+esc(q.question).substring(0,80)+(q.question.length>80?'...':'')+'</h4><p>Answer: '+esc(q.options[q.correctAnswer])+'</p><div class="aqa"><button class="aqb aqd" onclick="SS.adel(\''+sj.id+'\','+i+',\''+w.k+'\')">Delete</button></div></div>';});}
h+='</div>';});
h+='</div>';
}else{
h+='<div class="card"><div class="ct">Add Questions</div>';
h+='<div class="afr"><div class="afl">Week</div><div><select class="afs" id="aw">';
var yr=new Date().getFullYear();for(var n=Math.max(1,w.n-1);n<=w.n+4;n++){var wk2='w'+n+'_'+yr;h+='<option value="'+wk2+'"'+(n===w.n?' selected':'')+'>Week '+n+(n===w.n?' (Current)':'')+'</option>';}
h+='</select></div></div>';
h+='<div class="afr"><div class="afl">Subject</div><div><select class="afs" id="as">';SUBJ.forEach(function(s){h+='<option value="'+s.id+'">'+s.icon+' '+s.title+'</option>';});h+='</select></div></div>';
h+='<div class="afr"><div class="afl">Method</div><div><select class="afs" id="am"><option value="manual">Manual</option><option value="json">JSON</option></select></div></div>';

h+='<div id="me">';
h+='<div class="afr"><div class="afl">Passage <span style="font-size:.65rem;color:var(--tx3)">(Reading)</span></div><div><textarea class="aft" id="ap" placeholder="Reading passage (leave empty for other subjects)..."></textarea></div></div>';
h+='<div class="afr"><div class="afl">Question</div><div><textarea class="aft" id="aq" placeholder="Enter question..." style="min-height:60px"></textarea></div></div>';
h+='<div class="afr"><div class="afl">Option A</div><div><input class="afi" id="oA" placeholder="A"></div></div>';
h+='<div class="afr"><div class="afl">Option B</div><div><input class="afi" id="oB" placeholder="B"></div></div>';
h+='<div class="afr"><div class="afl">Option C</div><div><input class="afi" id="oC" placeholder="C"></div></div>';
h+='<div class="afr"><div class="afl">Option D</div><div><input class="afi" id="oD" placeholder="D"></div></div>';
h+='<div class="afr"><div class="afl">Correct</div><div><select class="afs" id="ac"><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option></select></div></div>';
h+='<div class="afr"><div class="afl">Explanation</div><div><textarea class="aft" id="ae" placeholder="Why this is correct..." style="min-height:60px"></textarea></div></div>';
h+='<div><button class="abtn" onclick="SS.addQ()">+ Add Question</button></div></div>';

h+='<div id="je" style="display:none"><div class="afr"><div class="afl">JSON</div><div><textarea class="aft" id="aj" placeholder=\'[{"passage":"...","question":"...","options":["A","B","C","D"],"correctAnswer":0,"explanation":"..."}]\' style="min-height:200px;font-family:monospace;font-size:.75rem"></textarea><div style="font-size:.7rem;color:var(--tx3);margin-top:.2rem">Array of objects: question, options[4], correctAnswer(0-3), explanation, passage(optional)</div></div></div>';
h+='<div><button class="abtn" onclick="SS.addJ()">Import JSON</button></div></div>';
h+='</div>';
}
h+='</div>';el.innerHTML=h;

if(S.adView==='create'){setTimeout(function(){var ms=document.getElementById('am');if(ms)ms.addEventListener('change',function(){document.getElementById('me').style.display=this.value==='manual'?'block':'none';document.getElementById('je').style.display=this.value==='json'?'block':'none';});},50);}
}

// ===== GLOBAL API =====
window.SS={};

SS.atab=function(t){S.adView=t;rv();};

SS.addQ=function(){var w=document.getElementById('aw').value,sj=document.getElementById('as').value,p=document.getElementById('ap').value.trim(),q=document.getElementById('aq').value.trim(),a=document.getElementById('oA').value.trim(),b=document.getElementById('oB').value.trim(),c=document.getElementById('oC').value.trim(),d=document.getElementById('oD').value.trim(),cr=parseInt(document.getElementById('ac').value),ex=document.getElementById('ae').value.trim();
if(!q||!a||!b||!c||!d){toast('Fill question + all options.','w');return;}
var qi={question:q,options:[a,b,c,d],correctAnswer:cr,explanation:ex||'‚Äî'};if(p&&sj==='reading')qi.passage=p;
if(!S.wTests[w])S.wTests[w]={};if(!S.wTests[w][sj])S.wTests[w][sj]={questions:[]};
S.wTests[w][sj].questions.push(qi);sv('ss_wt',S.wTests);
document.getElementById('aq').value='';document.getElementById('oA').value='';document.getElementById('oB').value='';document.getElementById('oC').value='';document.getElementById('oD').value='';document.getElementById('ae').value='';
toast('Added! ('+S.wTests[w][sj].questions.length+' total)');};

SS.addJ=function(){var w=document.getElementById('aw').value,sj=document.getElementById('as').value,js=document.getElementById('aj').value.trim();
try{var arr=JSON.parse(js);if(!Array.isArray(arr))throw new Error('Must be array');
arr.forEach(function(q){if(!q.question||!q.options||q.options.length!==4||q.correctAnswer===undefined)throw new Error('Bad format');});
if(!S.wTests[w])S.wTests[w]={};if(!S.wTests[w][sj])S.wTests[w][sj]={questions:[]};
arr.forEach(function(q){S.wTests[w][sj].questions.push({passage:q.passage||null,question:q.question,options:q.options,correctAnswer:q.correctAnswer,explanation:q.explanation||'‚Äî'});});
sv('ss_wt',S.wTests);document.getElementById('aj').value='';toast(arr.length+' imported!');
}catch(e){toast('Error: '+e.message,'w');}};

SS.adel=function(sj,i,wk2){if(!S.wTests[wk2]||!S.wTests[wk2][sj])return;S.wTests[wk2][sj].questions.splice(i,1);sv('ss_wt',S.wTests);toast('Deleted.');rv();};

// ===== TEST ENGINE =====
SS.start=function(tid){var w=wk();if(!w.open){toast('Tests available Tue‚ÄìSun.','w');return;}
var wt=S.wTests[w.k];if(!wt||!wt[tid]||!wt[tid].questions||wt[tid].questions.length===0){toast('No questions yet.','w');return;}
if(S.res.find(function(r){return r.tid===tid&&r.wk===w.k})){toast('Already completed.','w');return;}
var sj=SUBJ.find(function(s){return s.id===tid});
S.cur={tid:tid,wk:w.k,qs:wt[tid].questions,ans:{},qi:0,tl:sj.time*60,sa:Date.now()};S.paused=false;
openM(sj,true);};

SS.resume=function(tid){var pr=S.prog[tid];if(!pr){toast('No saved progress.','w');return;}
var w=wk();if(pr.wk!==w.k){delete S.prog[tid];sv('ss_ip',S.prog);toast('Expired (prev week).','w');rv();return;}
var wt=S.wTests[pr.wk];if(!wt||!wt[tid]){toast('Test data missing.','w');return;}
var sj=SUBJ.find(function(s){return s.id===tid});
S.cur={tid:tid,wk:pr.wk,qs:wt[tid].questions,ans:pr.ans||{},qi:pr.qi||0,tl:pr.tl||sj.time*60,sa:pr.sa||Date.now()};S.paused=false;
openM(sj,false);};

function openM(sj,pre){document.getElementById('tModal').classList.add('on');document.getElementById('mTi').textContent=sj.icon+' '+sj.title;document.getElementById('mTm').textContent=fmt(S.cur.tl);document.getElementById('mTm').classList.remove('w');document.getElementById('paOv').classList.remove('on');document.getElementById('mPa').textContent='‚è∏ Pause';document.getElementById('mPa').classList.remove('pd');document.getElementById('mPa').style.display='';document.getElementById('mTm').style.display='';
if(pre)rPreT();else{startT();rQ();}}

function rPreT(){var sj=SUBJ.find(function(s){return s.id===S.cur.tid});
document.getElementById('mBd').innerHTML='<div class="po"><span class="poi">‚ö†Ô∏è</span><div class="pot"><strong>Time Management Policy:</strong> You have <strong>6 days</strong> (Tue‚ÄìSun) to complete each test. Use the <strong>Pause</strong> button to save progress. If you don\'t pause, <strong>the test auto-submits when time runs out</strong>. This helps you practise time management for the Selective Schools exam.</div></div><div style="text-align:center;padding:1rem 0"><div style="font-size:.875rem;color:var(--tx2);margin-bottom:1.25rem">'+sj.icon+' '+sj.title+'<br>'+S.cur.qs.length+' questions ¬∑ '+sj.time+' minutes</div><button class="brn" id="bgBtn">Begin Test</button></div>';
document.getElementById('bgBtn').addEventListener('click',function(){startT();rQ();});}

function startT(){clearInterval(S.tInt);S.tInt=setInterval(function(){if(S.paused)return;S.cur.tl--;
document.getElementById('mTm').textContent=fmt(S.cur.tl);
if(S.cur.tl<=120)document.getElementById('mTm').classList.add('w');
if(S.cur.tl===120)toast('‚ö†Ô∏è 2 minutes left!','w');
if(S.cur.tl<=0){clearInterval(S.tInt);toast('‚è∞ Time\'s up! Auto-submitted.','w');subT();}
if(S.cur.tl%10===0)savP();},1000);}

function savP(){if(!S.cur)return;S.prog[S.cur.tid]={wk:S.cur.wk,ans:S.cur.ans,qi:S.cur.qi,tl:S.cur.tl,sa:S.cur.sa};sv('ss_ip',S.prog);}

function rQ(){var q=S.cur.qs[S.cur.qi],tot=S.cur.qs.length,num=S.cur.qi+1,sel=S.cur.ans[S.cur.qi];
var h='<div class="qp"><span class="qc">Q '+num+'/'+tot+'</span><div class="qbt"><div class="qbf" style="width:'+((num/tot)*100)+'%"></div></div></div>';
if(q.passage)h+='<div class="pas">'+esc(q.passage)+'</div>';
h+='<div class="qt">'+esc(q.question)+'</div><div class="ops">';
var lt=['A','B','C','D'];
q.options.forEach(function(o,i){h+='<div class="op'+(sel===i?' se':'')+'" data-i="'+i+'"><div class="ol">'+lt[i]+'</div><div>'+esc(o)+'</div></div>';});
h+='</div><div class="qn"><button class="qnb qnp" id="qP"'+(num===1?' disabled':'')+'>‚Üê Prev</button>';
h+=num===tot?'<button class="qnb qns" id="qS">Submit ‚úì</button>':'<button class="qnb qnn" id="qN">Next ‚Üí</button>';
h+='</div>';
document.getElementById('mBd').innerHTML=h;

document.querySelectorAll('.op').forEach(function(o){o.addEventListener('click',function(){var idx=parseInt(this.getAttribute('data-i'));S.cur.ans[S.cur.qi]=idx;document.querySelectorAll('.op').forEach(function(x){x.classList.remove('se')});this.classList.add('se');});});

var pB=document.getElementById('qP'),nB=document.getElementById('qN'),sB=document.getElementById('qS');
if(pB)pB.addEventListener('click',function(){if(S.cur.qi>0){S.cur.qi--;rQ();}});
if(nB)nB.addEventListener('click',function(){if(S.cur.qi<tot-1){S.cur.qi++;rQ();}});
if(sB)sB.addEventListener('click',function(){var ua=0;for(var i=0;i<tot;i++)if(S.cur.ans[i]===undefined)ua++;
if(ua>0)showCf('Submit?',ua+' unanswered. Submit anyway?',function(){subT();});
else showCf('Submit?','Sure? Answers can\'t be changed.',function(){subT();});});}

function subT(){clearInterval(S.tInt);if(!S.cur)return;
var cor=0,tot=S.cur.qs.length;S.cur.qs.forEach(function(q,i){if(S.cur.ans[i]===q.correctAnswer)cor++;});
var sj=SUBJ.find(function(s){return s.id===S.cur.tid}),tu=(sj.time*60)-S.cur.tl,pct=Math.round((cor/tot)*100);
var r={tid:S.cur.tid,wk:S.cur.wk,cor:cor,tot:tot,pct:pct,tu:fmt(tu),at:new Date().toISOString(),ans:S.cur.ans,sa:S.cur.sa};
S.res.push(r);sv('ss_rs',S.res);delete S.prog[S.cur.tid];sv('ss_ip',S.prog);showRes(r);}

function showRes(r){var sj=SUBJ.find(function(s){return s.id===r.tid});
var bc=r.pct>=80?'var(--green)':r.pct>=50?'var(--gold)':'var(--red)';
var msg=r.pct>=80?'Excellent!':r.pct>=50?'Good Effort!':'Keep Practising!';
document.getElementById('mBd').innerHTML='<div class="rc"><div class="rci" style="border-color:'+bc+'"><div class="rn" style="color:'+bc+'">'+r.pct+'%</div><div class="rp">Score</div></div><h2 style="font-size:1.25rem;margin-bottom:.25rem">'+msg+'</h2><p style="color:var(--tx2);font-size:.875rem">'+sj.title+'</p><div class="rg"><div class="ri"><div class="rv">'+r.cor+'/'+r.tot+'</div><div class="rlb">Correct</div></div><div class="ri"><div class="rv">'+r.tu+'</div><div class="rlb">Time Used</div></div><div class="ri"><div class="rv">'+r.wk.replace('w','W').replace('_','/')+'</div><div class="rlb">Week</div></div></div><div class="rbs"><button class="rb rb3" onclick="SS.rev(\''+r.tid+'\',\''+r.wk+'\')">üìù Review</button><button class="rb rb1" onclick="SS.clM()">Dashboard</button></div></div>';
document.getElementById('mPa').style.display='none';document.getElementById('mTm').style.display='none';}

// ===== VIEW RESULT =====
SS.vRes=function(tid,wk2){var r=S.res.find(function(x){return x.tid===tid&&x.wk===wk2});if(!r){toast('Not found.','w');return;}
var sj=SUBJ.find(function(s){return s.id===tid});
document.getElementById('tModal').classList.add('on');document.getElementById('mTi').textContent=sj.icon+' '+sj.title+' ‚Äî Result';
document.getElementById('mPa').style.display='none';document.getElementById('mTm').style.display='none';document.getElementById('paOv').classList.remove('on');showRes(r);};

// ===== REVIEW =====
SS.rev=function(tid,wk2){var r=S.res.find(function(x){return x.tid===tid&&x.wk===wk2});var wt=S.wTests[wk2];if(!r||!wt||!wt[tid]){toast('Data missing.','w');return;}
var qs=wt[tid].questions,ans=r.ans||{},lt=['A','B','C','D'];
var h='<h3 style="margin-bottom:1rem">Answer Review</h3>';
qs.forEach(function(q,i){var ua=ans[i],ic=ua===q.correctAnswer;
h+='<div style="margin-bottom:1.25rem;padding-bottom:1.25rem;border-bottom:1px solid var(--bdr)">';
h+='<span class="rtag '+(ic?'rtag-c':'rtag-w')+'">'+(ic?'‚úì Correct':'‚úó Incorrect')+'</span>';
if(q.passage)h+='<div class="pas" style="margin-bottom:.75rem;max-height:150px">'+esc(q.passage)+'</div>';
h+='<div class="qt">Q'+(i+1)+'. '+esc(q.question)+'</div><div class="ops" style="pointer-events:none">';
q.options.forEach(function(o,j){var cl='';if(j===q.correctAnswer)cl=' co';else if(j===ua&&!ic)cl=' wr';h+='<div class="op'+cl+'"><div class="ol">'+lt[j]+'</div><div>'+esc(o)+'</div></div>';});
h+='</div>';
if(!ic)h+='<div class="expl"><strong>Correct: '+lt[q.correctAnswer]+'</strong>'+(q.explanation?'<br>'+esc(q.explanation):'')+'</div>';
else if(q.explanation)h+='<div class="expl"><strong>Explanation:</strong> '+esc(q.explanation)+'</div>';
h+='</div>';});
h+='<div style="text-align:center;padding:1rem 0"><button class="rb rb1" onclick="SS.clM()">Back to Dashboard</button></div>';
document.getElementById('mBd').innerHTML=h;};

// ===== PAUSE/RESUME =====
document.getElementById('mPa').addEventListener('click',function(){if(!S.cur||S.cur.tl===undefined)return;
if(S.paused){S.paused=false;document.getElementById('paOv').classList.remove('on');this.textContent='‚è∏ Pause';this.classList.remove('pd');}
else{S.paused=true;document.getElementById('paOv').classList.add('on');document.getElementById('paTm').textContent=fmt(S.cur.tl);this.textContent='‚ñ∂ Resume';this.classList.add('pd');savP();toast('Paused. Progress saved.');}});
document.getElementById('reBtn').addEventListener('click',function(){S.paused=false;document.getElementById('paOv').classList.remove('on');document.getElementById('mPa').textContent='‚è∏ Pause';document.getElementById('mPa').classList.remove('pd');});

// ===== CLOSE MODAL =====
document.getElementById('mCl').addEventListener('click',function(){if(S.cur&&S.cur.tl!==undefined&&S.cur.tl>0){showCf('Leave Test?','Progress saved. Resume before Sunday 23:59.',function(){S.paused=true;savP();clM();});}else clM();});
SS.clM=function(){clM()};
function clM(){clearInterval(S.tInt);S.cur=null;S.paused=false;document.getElementById('tModal').classList.remove('on');document.getElementById('mPa').style.display='';document.getElementById('mTm').style.display='';rv();}

// ===== CONFIRM =====
var cfCb=null;
function showCf(t,m,cb){document.getElementById('cfTi').textContent=t;document.getElementById('cfMs').textContent=m;document.getElementById('cfBg').classList.add('on');cfCb=cb;}
document.getElementById('cfNo').addEventListener('click',function(){document.getElementById('cfBg').classList.remove('on');cfCb=null;});
document.getElementById('cfYe').addEventListener('click',function(){document.getElementById('cfBg').classList.remove('on');if(cfCb){cfCb();cfCb=null;}});

// ===== EXPORT/CLEAR =====
SS.exp=function(){var d={wt:S.wTests,rs:S.res,at:new Date().toISOString()};var b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});var u=URL.createObjectURL(b);var a=document.createElement('a');a.href=u;a.download='smartselective_'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(u);toast('Exported!');};
SS.clr=function(){showCf('Clear All?','Permanently deletes all data.',function(){S.res=[];S.prog={};S.wTests={};sv('ss_rs',S.res);sv('ss_ip',S.prog);sv('ss_wt',S.wTests);toast('Cleared.');rv();});};

// ===== NAV =====
document.querySelectorAll('.side a').forEach(function(a){a.addEventListener('click',function(e){e.preventDefault();var v=this.getAttribute('data-v');if(v)sw(v);});});

// ===== DEMO DATA =====
function loadDemo(){var w=wk();if(S.wTests[w.k])return;
S.wTests[w.k]={
reading:{questions:[
{passage:"The platypus is one of the most unusual creatures found in nature. Native to eastern Australia, this semi-aquatic mammal possesses a remarkable combination of features: a duck-like bill, a beaver-like tail, and venomous spurs on its hind legs. Unlike most mammals, the platypus lays eggs. Scientists were so bewildered when they first encountered a preserved specimen in 1799 that they suspected it was a hoax.",question:"What made scientists initially doubtful about the platypus?",options:["Its blend of features from different animals","Its ability to swim","Its small size","Its diet"],correctAnswer:0,explanation:"The passage states scientists 'suspected it was a hoax' due to its unusual combination of traits (duck bill, beaver tail). The correct answer uses 'blend of features' instead of repeating the passage's exact words."},
{passage:"The platypus is one of the most unusual creatures found in nature. Native to eastern Australia, this semi-aquatic mammal possesses a remarkable combination of features: a duck-like bill, a beaver-like tail, and venomous spurs on its hind legs. Unlike most mammals, the platypus lays eggs. Scientists were so bewildered when they first encountered a preserved specimen in 1799 that they suspected it was a hoax.",question:"The word 'bewildered' most closely means:",options:["Angry","Deeply puzzled","Excited","Uninterested"],correctAnswer:1,explanation:"'Bewildered' = confused/puzzled. Scientists couldn't understand what they saw."},
{passage:"Ancient Polynesian sailors crossed thousands of kilometres of open Pacific Ocean without instruments, relying on star positions, ocean swell patterns, and bird behaviour. This knowledge was passed down through oral tradition and practical apprenticeship.",question:"How was Polynesian navigation knowledge transmitted?",options:["Written textbooks","Spoken teachings and hands-on training","European maps","Government schools"],correctAnswer:1,explanation:"'Oral tradition' = spoken teachings; 'practical apprenticeship' = hands-on training. The answer uses synonyms."},
{passage:"The Great Barrier Reef supports over 1,500 species of fish. However, rising ocean temperatures have caused widespread coral bleaching, threatening the reef's delicate ecosystem.",question:"What primarily threatens the Great Barrier Reef?",options:["Overfishing","Increasing water temperatures","Tourist damage","Invasive species"],correctAnswer:1,explanation:"'Rising ocean temperatures' in the passage = 'increasing water temperatures' in the answer."},
{passage:"During sleep, the brain processes and consolidates memories, transferring information from short-term to long-term storage. Students who sleep adequately before exams perform significantly better than those who stay up cramming.",question:"Studying late before an exam is:",options:["Most effective","Counterproductive to performance","Only bad for young students","Sometimes beneficial"],correctAnswer:1,explanation:"The passage says adequate sleep = better performance, implying cramming is counterproductive."},
{passage:"Marie Curie moved to Paris for higher education when few women attended university. Despite considerable prejudice as a woman in science, her determination earned her two Nobel Prizes.",question:"What obstacle did Curie overcome?",options:["Lack of funding","Gender-based discrimination","Rival competition","Poor health"],correctAnswer:1,explanation:"'Considerable prejudice as a woman' = 'gender-based discrimination'. Same meaning, different words."},
{passage:"Marie Curie's research on radioactivity ‚Äî a term she herself coined ‚Äî earned her two Nobel Prizes.",question:"'Coined' means:",options:["Found accidentally","Created the term","Borrowed from another language","Misunderstood"],correctAnswer:1,explanation:"To 'coin' a term means to create/invent it."},
{passage:"Coral reefs occupy less than 1% of the ocean floor yet support 25% of marine species. They function like cities, providing shelter, food, and breeding grounds. Their existence depends on a fragile balance increasingly disrupted by human activity.",question:"Comparing reefs to cities suggests they:",options:["Are built by humans","Serve as dense functional hubs for marine life","Are near coastal cities","Will be replaced by artificial structures"],correctAnswer:1,explanation:"'Function like cities' + providing shelter/food = 'dense functional hubs'. The answer captures the meaning."},
{passage:"Before Gutenberg's press, books were copied by hand, making them scarce and prohibitively expensive. The press democratised knowledge, enabling ideas to circulate rapidly.",question:"'Democratised' suggests knowledge became:",options:["Government-controlled","Accessible to more people","Less reliable","Only for democracies"],correctAnswer:1,explanation:"Democratise = make available to all, not just privileged few."},
{passage:"Before the 2004 tsunami, elephants moved to higher ground, dogs refused outdoors, and flamingos abandoned breeding areas. Researchers believe animals may sense vibrations or pressure changes preceding disasters.",question:"Animals' disaster prediction abilities are:",options:["Fully understood","Not yet conclusively explained by science","Only for earthquakes","Limited to pets"],correctAnswer:1,explanation:"'Mechanisms remain debated' = 'not yet conclusively explained'. Same uncertainty, different phrasing."}
]},
math:{questions:[
{question:"A shop offers 20% off an $85 jacket. Sale price?",options:["$65","$68","$70","$72"],correctAnswer:1,explanation:"20% of $85 = $17. Sale = $85 - $17 = $68"},
{question:"If 3x + 7 = 22, x = ?",options:["3","4","5","6"],correctAnswer:2,explanation:"3x = 15, x = 5"},
{question:"Rectangle perimeter = 36cm, length = 11cm. Width?",options:["5cm","6cm","7cm","8cm"],correctAnswer:2,explanation:"2(11+w)=36 ‚Üí 11+w=18 ‚Üí w=7"},
{question:"15% of 240?",options:["32","34","36","38"],correctAnswer:2,explanation:"0.15 √ó 240 = 36"},
{question:"Train: 180km in 2.5hr. Average speed?",options:["62 km/h","68 km/h","72 km/h","75 km/h"],correctAnswer:2,explanation:"180 √∑ 2.5 = 72 km/h"},
{question:"Boys:Girls = 3:5, 24 total. How many boys?",options:["8","9","10","12"],correctAnswer:1,explanation:"8 parts, each = 3. Boys = 3√ó3 = 9"},
{question:"Triangle area: base 12cm, height 9cm?",options:["48cm¬≤","54cm¬≤","72cm¬≤","108cm¬≤"],correctAnswer:1,explanation:"¬Ω √ó 12 √ó 9 = 54cm¬≤"},
{question:"Bag: 3 red, 4 blue, 5 green. P(blue)?",options:["1/4","1/3","5/12","2/6"],correctAnswer:1,explanation:"4/12 = 1/3"},
{question:"2‚Åø = 64, n = ?",options:["4","5","6","7"],correctAnswer:2,explanation:"2‚Å∂ = 64"},
{question:"Pizza: 8 slices. Tom eats 3, Jane 2. Fraction left?",options:["1/8","2/8","3/8","4/8"],correctAnswer:2,explanation:"Left = 8-5 = 3 slices = 3/8"}
]},
verbal:{questions:[
{question:"Synonym of 'ABUNDANT':",options:["Scarce","Plentiful","Moderate","Partial"],correctAnswer:1,explanation:"Abundant = plentiful (large quantity)"},
{question:"BOOK:LIBRARY :: PAINTING:?",options:["Artist","Canvas","Gallery","Brush"],correctAnswer:2,explanation:"Books are in libraries; paintings in galleries."},
{question:"'The _____ weather forced cancellation.'",options:["clement","inclement","pleasant","moderate"],correctAnswer:1,explanation:"Inclement = harsh weather that causes cancellations."},
{question:"Odd one out: Oak, Elm, Fern, Maple",options:["Oak","Elm","Fern","Maple"],correctAnswer:2,explanation:"Fern is not a tree; others are deciduous trees."},
{question:"Opposite of 'CONCEAL':",options:["Hide","Reveal","Cover","Protect"],correctAnswer:1,explanation:"Conceal = hide. Opposite = reveal."},
{question:"WHISPER:SHOUT :: CRAWL:?",options:["Walk","Sprint","Move","Slide"],correctAnswer:1,explanation:"Whisper‚Üíshout (quiet‚Üíloud); crawl‚Üísprint (slow‚Üífast)."},
{question:"Correct spelling:",options:["Accomodate","Accommodate","Acomodate","Acommodate"],correctAnswer:1,explanation:"Double c, double m: accommodate."},
{question:"Correct 'their' usage:",options:["Their going to the park.","The students forgot their lunches.","They put it their.","Their is no way."],correctAnswer:1,explanation:"'Their' = possessive. 'Their lunches' is correct."},
{question:"Synonym of 'DILIGENT':",options:["Lazy","Careless","Industrious","Indifferent"],correctAnswer:2,explanation:"Diligent = industrious = hardworking."},
{question:"CLOCK:TIME :: THERMOMETER:?",options:["Heat","Temperature","Weather","Mercury"],correctAnswer:1,explanation:"Clock measures time; thermometer measures temperature."}
]},
quantitative:{questions:[
{question:"Pattern: 2, 6, 18, 54, ___",options:["108","162","216","72"],correctAnswer:1,explanation:"√ó3 each time. 54√ó3=162"},
{question:"‚óÜ+‚óÜ+‚ñ≤=20, ‚óÜ=7. ‚ñ≤=?",options:["4","5","6","7"],correctAnswer:2,explanation:"14+‚ñ≤=20 ‚Üí ‚ñ≤=6"},
{question:"Next: 1, 4, 9, 16, 25, ___",options:["30","35","36","49"],correctAnswer:2,explanation:"Perfect squares: 6¬≤=36"},
{question:"3, 5, 9, 15, 23, ?",options:["31","33","35","37"],correctAnswer:1,explanation:"Differences: +2,+4,+6,+8,+10. 23+10=33. Wait ‚Äî let me recheck: the answer should be 33."},
{question:"Clock at 3:15. Angle between hands?",options:["0¬∞","7.5¬∞","15¬∞","22.5¬∞"],correctAnswer:1,explanation:"Minute at 90¬∞. Hour moved 7.5¬∞ past 3. Angle=7.5¬∞"},
{question:"All Bloops are Razzles, all Razzles are Lazzles. Then:",options:["All Lazzles are Bloops","All Bloops are Lazzles","Some Lazzles aren't Razzles","No Bloops are Lazzles"],correctAnswer:1,explanation:"Bloops‚äÇRazzles‚äÇLazzles ‚Üí All Bloops are Lazzles."},
{question:"Squares in a 3√ó3 grid (any size)?",options:["9","10","13","14"],correctAnswer:3,explanation:"1√ó1:9 + 2√ó2:4 + 3√ó3:1 = 14"},
{question:"A1, C3, E5, G7, ___",options:["H8","I9","J10","H9"],correctAnswer:1,explanation:"Letters skip one (A,C,E,G,I). Numbers: odd (1,3,5,7,9). = I9"},
{question:"Cube painted red, cut into 8. How many have 3 red faces?",options:["4","6","8","2"],correctAnswer:2,explanation:"2√ó2√ó2 cut: all 8 are corners with 3 painted faces."},
{question:"Paper folded in half twice, corner cut. Holes when unfolded?",options:["1","2","4","8"],correctAnswer:2,explanation:"2 folds = 4 layers. Corner cut through all = 4 holes when unfolded."}
]}
};sv('ss_wt',S.wTests);}

// ===== INIT =====
SB.auth.getSession().then(function(r){var s=r.data.session;if(!s){window.location.href='/login.html';return;}
S.user=s.user;S.isAdmin=ADMINS.indexOf(s.user.email)!==-1;
loadDemo();
document.getElementById('loading').style.display='none';document.getElementById('app').style.display='block';
document.getElementById('em').textContent=s.user.email;document.getElementById('av').textContent=s.user.email.charAt(0).toUpperCase();
if(S.isAdmin){document.getElementById('adBadge').style.display='';document.getElementById('adNav').style.display='';}
rv();});

document.getElementById('logoutBtn').addEventListener('click',function(){SB.auth.signOut().then(function(){window.location.href='/login.html';});});
})();
</script>
</body>
</html>
