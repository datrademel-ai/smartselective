<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SmartSelective</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Newsreader:opsz,wght@6..72,400;6..72,600;6..72,700&display=swap" rel="stylesheet">
    <style>
:root{--navy:#0f172a;--blue:#2563eb;--blue-l:#3b82f6;--blue-p:#dbeafe;--blue-g:#eff6ff;--green:#059669;--green-p:#d1fae5;--red:#dc2626;--red-p:#fee2e2;--bg:#f8fafc;--card:#fff;--tx:#0f172a;--tx2:#475569;--tx3:#94a3b8;--bdr:#e2e8f0;--sh:0 4px 24px rgba(0,0,0,.08);--r:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;display:flex;flex-direction:column}
h1,h2{font-family:'Newsreader',serif}
.hdr{background:var(--card);border-bottom:1px solid var(--bdr);padding:1rem 0}
.hdr-i{max-width:1200px;margin:0 auto;padding:0 1.5rem;display:flex;justify-content:space-between;align-items:center}
.logo{font-family:'Newsreader',serif;font-size:1.5rem;font-weight:700;color:var(--navy);text-decoration:none;display:flex;align-items:center}
.logo svg{height:40px;width:auto}
.logo em{font-style:normal;color:var(--blue)}
.hdr-nav{display:flex;gap:1.5rem;align-items:center}
.hdr-nav a{font-size:.875rem;color:var(--tx2);text-decoration:none;font-weight:500}
.hdr-nav a:hover{color:var(--blue)}
.btn-s{background:var(--blue);color:#fff;padding:.5rem 1.25rem;border-radius:8px;font-weight:600;font-size:.875rem}
.btn-s:hover{background:var(--navy)}
.main{flex:1;display:flex;align-items:center;justify-content:center;padding:2rem 1rem}
.card{background:var(--card);border-radius:var(--r);box-shadow:var(--sh);padding:2.5rem;width:100%;max-width:420px}
.card h1{font-size:1.75rem;margin-bottom:.5rem;text-align:center}
.card p{color:var(--tx2);font-size:.9375rem;text-align:center;margin-bottom:1.75rem}
.fg{margin-bottom:1.25rem}
.fg label{display:block;font-size:.8125rem;font-weight:600;color:var(--tx);margin-bottom:.4rem}
.fg input{width:100%;padding:.75rem 1rem;border:1px solid var(--bdr);border-radius:8px;font-family:inherit;font-size:.9375rem;transition:.15s}
.fg input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px var(--blue-p)}
.btn{width:100%;padding:.875rem;background:var(--blue);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer;transition:.15s}
.btn:hover{background:var(--navy)}
.btn:disabled{background:var(--bdr);cursor:not-allowed}
.divider{display:flex;align-items:center;gap:1rem;margin:1.5rem 0;color:var(--tx3);font-size:.8125rem}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--bdr)}
.link{text-align:center;margin-top:1.5rem;font-size:.875rem;color:var(--tx2)}
.link a{color:var(--blue);font-weight:600;text-decoration:none}
.link a:hover{text-decoration:underline}
.alert{padding:.875rem 1rem;border-radius:8px;font-size:.8125rem;margin-bottom:1.25rem;display:none}
.alert-e{background:var(--red-p);color:var(--red);border:1px solid #fecaca}
.alert-s{background:var(--green-p);color:var(--green);border:1px solid #a7f3d0}
.ftr{text-align:center;padding:1.5rem;color:var(--tx3);font-size:.8125rem;border-top:1px solid var(--bdr)}
.spinner{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;margin-right:.5rem}
@keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
<header class="hdr">
    <div class="hdr-i">
        <a href="/" class="logo">
            <svg width="240" height="40" viewBox="0 0 240 40" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="shieldL" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#2563EB;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#1E40AF;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="letterL" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#E0E7FF;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="penL" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#475569;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#1E293B;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <g transform="translate(5, 3)">
                    <g opacity="0.9">
                        <g transform="rotate(-28 18 18)">
                            <rect x="15.5" y="-3" width="4" height="42" fill="url(#penL)" rx="2"/>
                            <rect x="15.5" y="-3" width="4" height="8" fill="#1E293B" rx="2"/>
                            <rect x="16" y="-1.5" width="3" height="5" fill="#FCD34D" rx="0.7"/>
                            <circle cx="17.5" cy="1" r="0.9" fill="#F59E0B"/>
                            <polygon points="15.5,39 19.5,39 17.5,43" fill="#1E293B"/>
                            <polygon points="16,39 19,39 17.5,41.5" fill="#64748B"/>
                        </g>
                        <g transform="rotate(28 18 18)">
                            <rect x="16.5" y="-3" width="4" height="42" fill="url(#penL)" rx="2"/>
                            <rect x="16.5" y="-3" width="4" height="8" fill="#1E293B" rx="2"/>
                            <rect x="17" y="-1.5" width="3" height="5" fill="#FCD34D" rx="0.7"/>
                            <circle cx="18.5" cy="1" r="0.9" fill="#F59E0B"/>
                            <polygon points="16.5,39 20.5,39 18.5,43" fill="#1E293B"/>
                            <polygon points="17,39 20,39 18.5,41.5" fill="#64748B"/>
                        </g>
                    </g>
                    <path d="M 18 2 L 29 6 L 29 21 Q 29 28 18 34 Q 7 28 7 21 L 7 6 Z" fill="url(#shieldL)" stroke="#1E40AF" stroke-width="0.9"/>
                    <path d="M 18 5 L 27 8.5 L 27 21 Q 27 26.5 18 31 Q 9 26.5 9 21 L 9 8.5 Z" fill="none" stroke="#3B82F6" stroke-width="0.45" opacity="0.3"/>
                    <text x="18" y="22.5" font-family="Arial" font-size="17" font-weight="700" fill="url(#letterL)" text-anchor="middle" stroke="#1E40AF" stroke-width="0.22">SS</text>
                    <circle cx="18" cy="3.5" r="1.3" fill="#FCD34D"/>
                    <circle cx="18" cy="3.5" r="0.65" fill="#FFFFFF" opacity="0.8"/>
                </g>
                <text x="45" y="24" font-family="Arial" font-size="17" font-weight="700" fill="#1E293B">Smart<tspan fill="#2563EB">Selective</tspan></text>
                <line x1="45" y1="28" x2="145" y2="28" stroke="#2563EB" stroke-width="0.7"/>
                <text x="45" y="34" font-family="Arial" font-size="4.5" fill="#64748B" letter-spacing="0.8">VIC SELECTIVE SCHOOLS PREP</text>
            </svg>
        </a>
        <nav class="hdr-nav">
            <a href="/pricing.html">Pricing</a>
            <a href="/signup.html" class="btn-s">Sign Up</a>
        </nav>
    </div>
</header>

<main class="main">
    <div class="card">
        <h1>Welcome Back</h1>
        <p>Log in to continue your test preparation</p>
        
        <div class="alert alert-e" id="alertE"></div>
        <div class="alert alert-s" id="alertS"></div>
        
        <form id="loginForm">
            <div class="fg">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" placeholder="you@example.com" required autocomplete="email">
            </div>
            <div class="fg">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="••••••••" required autocomplete="current-password">
            </div>
            <button type="submit" class="btn" id="submitBtn">Log In</button>
        </form>
        
        <div class="link">
            Don't have an account? <a href="/signup.html">Sign up</a>
        </div>
    </div>
</main>

<footer class="ftr">
    © 2026 SmartSelective. Prepare smarter, score higher.
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function() {
'use strict';

var SB = window.supabase.createClient(
    'https://qeowtqkfotypsrkfaniw.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlb3d0cWtmb3R5cHNya2Zhbml3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNDUwNjYsImV4cCI6MjA4NTcyMTA2Nn0.Og5eSoXdP-5hSEC1CnH1jYZ8BiscaL9Ah5KhQhaO0eA'
);

var form = document.getElementById('loginForm');
var btn = document.getElementById('submitBtn');
var alertE = document.getElementById('alertE');
var alertS = document.getElementById('alertS');

function showError(msg) {
    alertE.textContent = msg;
    alertE.style.display = 'block';
    alertS.style.display = 'none';
}

function showSuccess(msg) {
    alertS.textContent = msg;
    alertS.style.display = 'block';
    alertE.style.display = 'none';
}

function setLoading(loading) {
    btn.disabled = loading;
    btn.innerHTML = loading ? '<span class="spinner"></span>Logging in...' : 'Log In';
}

// 이미 로그인되어 있으면 대시보드로 리다이렉트
SB.auth.getSession().then(function(r) {
    if (r.data.session) {
        window.location.href = '/dashboard.html';
    }
});

form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    var email = document.getElementById('email').value.trim();
    var password = document.getElementById('password').value;
    
    if (!email || !password) {
        showError('Please enter email and password.');
        return;
    }
    
    setLoading(true);
    alertE.style.display = 'none';
    alertS.style.display = 'none';
    
    try {
        // Supabase 로그인
        var { data, error } = await SB.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        // ============================================================
        // 계정 활성화 상태 확인
        // ============================================================
        var { data: profile, error: profileError } = await SB.from('profiles')
            .select('is_active')
            .eq('id', data.user.id)
            .single();
        
        if (profile && profile.is_active === false) {
            await SB.auth.signOut();
            showError('Your account has been disabled. Please contact support.');
            setLoading(false);
            return;
        }
        
        // ============================================================
        // 단일 기기 로그인: 세션 ID 생성 및 저장
        // ============================================================
        var sessionId = crypto.randomUUID();
        
        // DB에 세션 ID 저장
        var { error: updateError } = await SB.from('profiles')
            .update({ 
                active_session_id: sessionId,
                last_active: new Date().toISOString()
            })
            .eq('id', data.user.id);
        
        if (updateError) {
            console.error('Session update error:', updateError);
            // 에러가 있어도 로그인은 진행 (graceful degradation)
        }
        
        // localStorage에 세션 ID 저장
        localStorage.setItem('ss_session_id', sessionId);
        
        showSuccess('Login successful! Redirecting...');
        
        setTimeout(function() {
            window.location.href = '/dashboard.html';
        }, 500);
        
    } catch (err) {
        console.error('Login error:', err);
        
        var msg = 'Login failed. Please try again.';
        if (err.message) {
            if (err.message.includes('Invalid login credentials')) {
                msg = 'Invalid email or password.';
            } else if (err.message.includes('Email not confirmed')) {
                msg = 'Please verify your email before logging in.';
            } else {
                msg = err.message;
            }
        }
        
        showError(msg);
        setLoading(false);
    }
});

})();
</script>
</body>
</html>
