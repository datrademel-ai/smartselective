<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - SmartSelective Beta</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; color: #333; }
        nav { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem 0; }
        nav .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        nav .logo { font-size: 1.5rem; font-weight: bold; color: #2563eb; text-decoration: none; display: flex; align-items: center; }
        nav .logo svg { height: 45px; width: auto; }

        .signup-section { padding: 3rem 0; min-height: calc(100vh - 80px); }
        .signup-container { max-width: 520px; margin: 0 auto; background: white; border-radius: 12px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .signup-header { text-align: center; margin-bottom: 2rem; }
        .signup-header h1 { font-size: 2rem; color: #2563eb; margin-bottom: 0.5rem; }
        .signup-header p { color: #6b7280; }

        .beta-banner { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 1.2rem; 
            border-radius: 10px; 
            margin-bottom: 1.5rem; 
            text-align: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .beta-banner .main-title { 
            font-size: 1.3rem; 
            font-weight: bold; 
            margin-bottom: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .beta-banner .price-line { 
            font-size: 1.1rem; 
            margin-bottom: 0.4rem;
        }
        .beta-banner .price-highlight { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #fde047;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .beta-banner .regular-price { 
            font-size: 0.9rem; 
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        .beta-banner .urgency { 
            font-size: 0.85rem; 
            margin-top: 0.6rem; 
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            background: rgba(253, 224, 71, 0.2);
            border-radius: 6px;
            display: inline-block;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-row .form-group { margin-bottom: 0; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 500; font-size: 0.9rem; }
        .form-group label .required { color: #dc2626; margin-left: 2px; }
        .form-group input { width: 100%; padding: 0.7rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; }
        .form-group input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .field-hint { font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem; }

        .divider { border: none; border-top: 1px solid #e5e7eb; margin: 1.5rem 0; }

        .consent-section h3 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151; }
        .consent-item { display: flex; align-items: flex-start; gap: 0.6rem; margin-bottom: 0.75rem; padding: 0.6rem 0.75rem; background: #f9fafb; border-radius: 6px; }
        .consent-item input[type="checkbox"] { margin-top: 3px; width: 18px; height: 18px; flex-shrink: 0; accent-color: #2563eb; cursor: pointer; }
        .consent-item label { font-size: 0.875rem; color: #4b5563; cursor: pointer; line-height: 1.4; }
        .consent-item label .tag { font-size: 0.7rem; font-weight: 600; padding: 1px 6px; border-radius: 3px; margin-left: 4px; }
        .tag-required { background: #fee2e2; color: #dc2626; }
        .tag-optional { background: #e0e7ff; color: #4338ca; }

        .turnstile-wrap { display: flex; justify-content: center; margin: 1.5rem 0; }

        .submit-btn { width: 100%; padding: 1rem; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .submit-btn:hover { background: #1d4ed8; }
        .submit-btn:disabled { background: #9ca3af; cursor: not-allowed; }

        .login-link { text-align: center; margin-top: 1.5rem; color: #6b7280; }
        .login-link a { color: #2563eb; text-decoration: none; font-weight: 500; }

        .error-message { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 0.85rem; border-radius: 8px; margin-bottom: 1rem; display: none; font-size: 0.9rem; }
        .success-message { background: #f0fdf4; border: 1px solid #bbf7d0; color: #16a34a; padding: 0.85rem; border-radius: 8px; margin-bottom: 1rem; display: none; font-size: 0.9rem; }
    </style>
</head>
<body>
    <nav><div class="container"><a href="/" class="logo">
        <svg width="250" height="45" viewBox="0 0 250 45" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="shieldS" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#2563EB;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#1E40AF;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="letterS" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#E0E7FF;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="penS" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#475569;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#1E293B;stop-opacity:1" />
                </linearGradient>
            </defs>
            <g transform="translate(6, 4)">
                <g opacity="0.9">
                    <g transform="rotate(-28 19 19)">
                        <rect x="16" y="-3.5" width="4.2" height="44" fill="url(#penS)" rx="2.1"/>
                        <rect x="16" y="-3.5" width="4.2" height="8.5" fill="#1E293B" rx="2.1"/>
                        <rect x="16.4" y="-1.8" width="3.4" height="5.2" fill="#FCD34D" rx="0.75"/>
                        <circle cx="18.1" cy="1" r="0.95" fill="#F59E0B"/>
                        <polygon points="16,40.5 20.2,40.5 18.1,45" fill="#1E293B"/>
                        <polygon points="16.5,40.5 19.7,40.5 18.1,43" fill="#64748B"/>
                    </g>
                    <g transform="rotate(28 19 19)">
                        <rect x="17" y="-3.5" width="4.2" height="44" fill="url(#penS)" rx="2.1"/>
                        <rect x="17" y="-3.5" width="4.2" height="8.5" fill="#1E293B" rx="2.1"/>
                        <rect x="17.4" y="-1.8" width="3.4" height="5.2" fill="#FCD34D" rx="0.75"/>
                        <circle cx="19.1" cy="1" r="0.95" fill="#F59E0B"/>
                        <polygon points="17,40.5 21.2,40.5 19.1,45" fill="#1E293B"/>
                        <polygon points="17.5,40.5 20.7,40.5 19.1,43" fill="#64748B"/>
                    </g>
                </g>
                <path d="M 19 2.3 L 30.5 6.5 L 30.5 22.5 Q 30.5 30 19 36 Q 7.5 30 7.5 22.5 L 7.5 6.5 Z" fill="url(#shieldS)" stroke="#1E40AF" stroke-width="0.95"/>
                <path d="M 19 5.5 L 28 9 L 28 22.5 Q 28 28.5 19 33 Q 10 28.5 10 22.5 L 10 9 Z" fill="none" stroke="#3B82F6" stroke-width="0.48" opacity="0.3"/>
                <text x="19" y="24" font-family="Arial" font-size="17.5" font-weight="700" fill="url(#letterS)" text-anchor="middle" stroke="#1E40AF" stroke-width="0.24">SS</text>
                <circle cx="19" cy="3.8" r="1.4" fill="#FCD34D"/>
                <circle cx="19" cy="3.8" r="0.7" fill="#FFFFFF" opacity="0.8"/>
            </g>
            <text x="48" y="25.5" font-family="Arial" font-size="18" font-weight="700" fill="#1E293B">Smart<tspan fill="#2563EB">Selective</tspan></text>
            <line x1="48" y1="29.5" x2="152" y2="29.5" stroke="#2563EB" stroke-width="0.75"/>
            <text x="48" y="36" font-family="Arial" font-size="4.8" fill="#64748B" letter-spacing="0.85">VIC SELECTIVE SCHOOLS PREP</text>
        </svg>
    </a></div></nav>

    <section class="signup-section">
        <div class="container">
            <div class="signup-container">
                <div class="signup-header">
                    <div class="beta-banner">
                        <div class="main-title">üéâ SPECIAL OFFER üéâ</div>
                        <div class="price-line">
                            FREE until Feb 28 ‚Ä¢ Then <span class="price-highlight">$79/month</span>
                        </div>


                    </div>
                    <h1>Join SmartSelective</h1>
                    <p>Start your VIC Selective Schools test preparation</p>
                </div>

                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>

                <form id="signupForm" novalidate>
                    <!-- Name -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Last Name <span class="required">*</span></label>
                            <input type="text" id="lastName" required placeholder="Family name">
                        </div>
                        <div class="form-group">
                            <label>First Name <span class="required">*</span></label>
                            <input type="text" id="firstName" required placeholder="Given name">
                        </div>
                    </div>

                    <!-- Email (= Login ID) -->
                    <div class="form-group">
                        <label>Email (Login ID) <span class="required">*</span></label>
                        <input type="email" id="email" required placeholder="your.email@example.com">
                        <div class="field-hint">This will be your login ID</div>
                    </div>

                    <!-- Phone -->
                    <div class="form-group">
                        <label>Contact Number <span class="required">*</span></label>
                        <input type="tel" id="phone" required placeholder="04XX XXX XXX">
                    </div>

                    <!-- Password -->
                    <div class="form-group">
                        <label>Password <span class="required">*</span></label>
                        <input type="password" id="password" required minlength="8" placeholder="Min 8 characters">
                        <div class="field-hint">Must include letters, numbers, and a special character (!@#$%^&*)</div>
                    </div>

                    <div class="form-group">
                        <label>Confirm Password <span class="required">*</span></label>
                        <input type="password" id="confirmPassword" required placeholder="Re-enter your password">
                    </div>

                    <hr class="divider">

                    <!-- Consent -->
                    <div class="consent-section">
                        <h3>Terms &amp; Consent</h3>

                        <div class="consent-item">
                            <input type="checkbox" id="consentPrivacy">
                            <label for="consentPrivacy">
                                I agree to the collection and use of my personal information for service operation.
                                <span class="tag tag-required">Required</span>
                            </label>
                        </div>

                        <div class="consent-item">
                            <input type="checkbox" id="consentEmail">
                            <label for="consentEmail">
                                I agree to the collection of my email address for account management and communication.
                                <span class="tag tag-required">Required</span>
                            </label>
                        </div>

                        <div class="consent-item">
                            <input type="checkbox" id="consentMarketing">
                            <label for="consentMarketing">
                                I agree to receive promotional emails and notifications about new features and offers.
                                <span class="tag tag-optional">Optional</span>
                            </label>
                        </div>
                    </div>

                    <!-- Turnstile -->
                    <div class="turnstile-wrap">
                        <!-- ‚ö†Ô∏è REPLACE data-sitekey with your Cloudflare Turnstile Site Key -->
                        <div class="cf-turnstile" data-sitekey="0x4AAAAAACXpwGor-eJ0CZih" data-callback="onTurnstileSuccess"></div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn">Sign Up</button>
                </form>

                <div class="login-link">
                    Already have an account? <a href="/login.html">Log In</a>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    var turnstileToken = null;
    function onTurnstileSuccess(token) { turnstileToken = token; }

    (function() {
        var sb = window.supabase.createClient(
            'https://qeowtqkfotypsrkfaniw.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlb3d0cWtmb3R5cHNya2Zhbml3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNDUwNjYsImV4cCI6MjA4NTcyMTA2Nn0.Og5eSoXdP-5hSEC1CnH1jYZ8BiscaL9Ah5KhQhaO0eA'
        );

        var form = document.getElementById('signupForm');
        var errorDiv = document.getElementById('errorMessage');
        var successDiv = document.getElementById('successMessage');
        var submitBtn = document.getElementById('submitBtn');

        function showError(msg) {
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validatePassword(pw) {
            var hasLetter = /[a-zA-Z]/.test(pw);
            var hasNumber = /[0-9]/.test(pw);
            var hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pw);
            return pw.length >= 8 && hasLetter && hasNumber && hasSpecial;
        }

        // Ïù¥ÎØ∏ Î°úÍ∑∏Ïù∏ÎêòÏñ¥ ÏûàÏúºÎ©¥ ÎåÄÏãúÎ≥¥ÎìúÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
        sb.auth.getSession().then(function(r) {
            if (r.data.session) {
                window.location.href = '/dashboard.html';
            }
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            errorDiv.style.display = 'none';

            var lastName = document.getElementById('lastName').value.trim();
            var firstName = document.getElementById('firstName').value.trim();
            var email = document.getElementById('email').value.trim();
            var phone = document.getElementById('phone').value.trim();
            var password = document.getElementById('password').value;
            var confirmPassword = document.getElementById('confirmPassword').value;
            var privacyOk = document.getElementById('consentPrivacy').checked;
            var emailOk = document.getElementById('consentEmail').checked;
            var marketingOk = document.getElementById('consentMarketing').checked;

            // Validation
            if (!lastName || !firstName) { showError('Please enter your full name.'); return; }
            if (!email) { showError('Please enter your email address.'); return; }
            if (!phone) { showError('Please enter your contact number.'); return; }
            if (!validatePassword(password)) {
                showError('Password must be at least 8 characters with letters, numbers, and a special character.');
                return;
            }
            if (password !== confirmPassword) { showError('Passwords do not match.'); return; }
            if (!privacyOk) { showError('You must agree to the personal information collection policy.'); return; }
            if (!emailOk) { showError('You must agree to the email collection policy.'); return; }
            if (!turnstileToken) { showError('Please complete the security verification.'); return; }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating account...';

            try {
                // 1. Create auth user in Supabase Auth
                var authResult = await sb.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            last_name: lastName,
                            first_name: firstName,
                            phone: phone
                        }
                    }
                });
                if (authResult.error) throw authResult.error;

                var user = authResult.data.user;
                if (!user) throw new Error('Failed to create account.');

                // 2. ÏÑ∏ÏÖò ID ÏÉùÏÑ± (Îã®Ïùº Í∏∞Í∏∞ Î°úÍ∑∏Ïù∏Ïö©)
                var sessionId = crypto.randomUUID();

                // 3. profiles ÌÖåÏù¥Î∏îÏóê Ï†ÄÏû• (Î≤†ÌÉÄ Î©§Î≤ÑÎ°ú ÌëúÏãú!)
                var displayName = firstName + ' ' + lastName;
                var profileResult = await sb.from('profiles').upsert({
                    id: user.id,
                    email: email,
                    display_name: displayName,
                    phone: phone,
                    role: 'student',
                    is_active: true,
                    subscription_status: 'beta_79',
                    subscription_tier: 'beta_79',
                    lifetime_price: 79,
                    active_session_id: sessionId,
                    last_active: new Date().toISOString(),
                    privacy_agreed: privacyOk,
                    email_collection_agreed: emailOk,
                    marketing_agreed: marketingOk
                });
                
                if (profileResult.error) {
                    console.warn('Profile save warning:', profileResult.error.message);
                }

                // 4. localStorageÏóê ÏÑ∏ÏÖò ID Ï†ÄÏû•
                localStorage.setItem('ss_session_id', sessionId);

                // 5. Ïù¥Î©îÏùº ÌôïÏù∏Ïù¥ ÌïÑÏöîÌïúÏßÄ Ï≤¥ÌÅ¨
                if (authResult.data.session) {
                    // Ïù¥Î©îÏùº ÌôïÏù∏ ÏóÜÏù¥ Î∞îÎ°ú Î°úÍ∑∏Ïù∏Îê® ‚Üí ÎåÄÏãúÎ≥¥ÎìúÎ°ú Ïù¥Îèô
                    window.location.href = '/dashboard.html';
                } else {
                    // Ïù¥Î©îÏùº ÌôïÏù∏ ÌïÑÏöî
                    successDiv.innerHTML = 'üéâ <b>Congrats! You\'re now a Founding Member!</b><br><br>Please check your email (<b>' + email + '</b>) to verify your account, then <a href="/login.html" style="color:#16a34a;font-weight:600;">log in here</a>.<br><br>‚úÖ FREE until Feb 28<br>‚úÖ Then $79/month forever (Regular: $99/month)';
                    successDiv.style.display = 'block';
                    form.style.display = 'none';
                }

            } catch (err) {
                var errMsg = err.message || 'An error occurred. Please try again.';
                if (errMsg.includes('already registered')) {
                    errMsg = 'This email is already registered. Please log in or use a different email.';
                }
                showError(errMsg);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sign Up';
                // Reset Turnstile
                if (window.turnstile) { turnstile.reset(); turnstileToken = null; }
            }
        });
    })();
    </script>
</body>
</html>
