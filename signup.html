<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - SmartSelective</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; color: #333; }
        nav { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem 0; }
        nav .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        nav .logo { font-size: 1.5rem; font-weight: bold; color: #2563eb; text-decoration: none; }

        .signup-section { padding: 3rem 0; min-height: calc(100vh - 80px); }
        .signup-container { max-width: 520px; margin: 0 auto; background: white; border-radius: 12px; padding: 2.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .signup-header { text-align: center; margin-bottom: 2rem; }
        .signup-header h1 { font-size: 2rem; color: #2563eb; margin-bottom: 0.5rem; }
        .signup-header p { color: #6b7280; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-row .form-group { margin-bottom: 0; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 500; font-size: 0.9rem; }
        .form-group label .required { color: #dc2626; margin-left: 2px; }
        .form-group input { width: 100%; padding: 0.7rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; }
        .form-group input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .field-hint { font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem; }

        .divider { border: none; border-top: 1px solid #e5e7eb; margin: 1.5rem 0; }

        .consent-section h3 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151; }
        .consent-item { display: flex; align-items: flex-start; gap: 0.6rem; margin-bottom: 0.75rem; padding: 0.6rem 0.75rem; background: #f9fafb; border-radius: 6px; }
        .consent-item input[type="checkbox"] { margin-top: 3px; width: 18px; height: 18px; flex-shrink: 0; accent-color: #2563eb; cursor: pointer; }
        .consent-item label { font-size: 0.875rem; color: #4b5563; cursor: pointer; line-height: 1.4; }
        .consent-item label .tag { font-size: 0.7rem; font-weight: 600; padding: 1px 6px; border-radius: 3px; margin-left: 4px; }
        .tag-required { background: #fee2e2; color: #dc2626; }
        .tag-optional { background: #e0e7ff; color: #4338ca; }

        .turnstile-wrap { display: flex; justify-content: center; margin: 1.5rem 0; }

        .submit-btn { width: 100%; padding: 1rem; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .submit-btn:hover { background: #1d4ed8; }
        .submit-btn:disabled { background: #9ca3af; cursor: not-allowed; }

        .login-link { text-align: center; margin-top: 1.5rem; color: #6b7280; }
        .login-link a { color: #2563eb; text-decoration: none; font-weight: 500; }

        .error-message { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 0.85rem; border-radius: 8px; margin-bottom: 1rem; display: none; font-size: 0.9rem; }
        .success-message { background: #f0fdf4; border: 1px solid #bbf7d0; color: #16a34a; padding: 0.85rem; border-radius: 8px; margin-bottom: 1rem; display: none; font-size: 0.9rem; }
    </style>
</head>
<body>
    <nav><div class="container"><a href="/" class="logo">SmartSelective</a></div></nav>

    <section class="signup-section">
        <div class="container">
            <div class="signup-container">
                <div class="signup-header">
                    <h1>Create Your Account</h1>
                    <p>Start preparing for VIC Selective Schools exam</p>
                </div>

                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>

                <form id="signupForm" novalidate>
                    <!-- Name -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Last Name <span class="required">*</span></label>
                            <input type="text" id="lastName" required placeholder="Family name">
                        </div>
                        <div class="form-group">
                            <label>First Name <span class="required">*</span></label>
                            <input type="text" id="firstName" required placeholder="Given name">
                        </div>
                    </div>

                    <!-- Email (= Login ID) -->
                    <div class="form-group">
                        <label>Email (Login ID) <span class="required">*</span></label>
                        <input type="email" id="email" required placeholder="your.email@example.com">
                        <div class="field-hint">This will be your login ID</div>
                    </div>

                    <!-- Phone -->
                    <div class="form-group">
                        <label>Contact Number <span class="required">*</span></label>
                        <input type="tel" id="phone" required placeholder="04XX XXX XXX">
                    </div>

                    <!-- Password -->
                    <div class="form-group">
                        <label>Password <span class="required">*</span></label>
                        <input type="password" id="password" required minlength="8" placeholder="Min 8 characters">
                        <div class="field-hint">Must include letters, numbers, and a special character (!@#$%^&*)</div>
                    </div>

                    <div class="form-group">
                        <label>Confirm Password <span class="required">*</span></label>
                        <input type="password" id="confirmPassword" required placeholder="Re-enter your password">
                    </div>

                    <hr class="divider">

                    <!-- Consent -->
                    <div class="consent-section">
                        <h3>Terms &amp; Consent</h3>

                        <div class="consent-item">
                            <input type="checkbox" id="consentPrivacy">
                            <label for="consentPrivacy">
                                I agree to the collection and use of my personal information for service operation.
                                <span class="tag tag-required">Required</span>
                            </label>
                        </div>

                        <div class="consent-item">
                            <input type="checkbox" id="consentEmail">
                            <label for="consentEmail">
                                I agree to the collection of my email address for account management and communication.
                                <span class="tag tag-required">Required</span>
                            </label>
                        </div>

                        <div class="consent-item">
                            <input type="checkbox" id="consentMarketing">
                            <label for="consentMarketing">
                                I agree to receive promotional emails and notifications about new features and offers.
                                <span class="tag tag-optional">Optional</span>
                            </label>
                        </div>
                    </div>

                    <!-- Turnstile -->
                    <div class="turnstile-wrap">
                        <!-- ⚠️ REPLACE data-sitekey with your Cloudflare Turnstile Site Key -->
                        <div class="cf-turnstile" data-sitekey="0x4AAAAAACXpwGor-eJ0CZih" data-callback="onTurnstileSuccess"></div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn">Create Account</button>
                </form>

                <div class="login-link">
                    Already have an account? <a href="/login.html">Log In</a>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    var turnstileToken = null;
    function onTurnstileSuccess(token) { turnstileToken = token; }

    (function() {
        var sb = window.supabase.createClient(
            'https://qeowtqkfotypsrkfaniw.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlb3d0cWtmb3R5cHNya2Zhbml3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNDUwNjYsImV4cCI6MjA4NTcyMTA2Nn0.Og5eSoXdP-5hSEC1CnH1jYZ8BiscaL9Ah5KhQhaO0eA'
        );

        var form = document.getElementById('signupForm');
        var errorDiv = document.getElementById('errorMessage');
        var successDiv = document.getElementById('successMessage');
        var submitBtn = document.getElementById('submitBtn');

        function showError(msg) {
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validatePassword(pw) {
            var hasLetter = /[a-zA-Z]/.test(pw);
            var hasNumber = /[0-9]/.test(pw);
            var hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pw);
            return pw.length >= 8 && hasLetter && hasNumber && hasSpecial;
        }

        // 이미 로그인되어 있으면 대시보드로 리다이렉트
        sb.auth.getSession().then(function(r) {
            if (r.data.session) {
                window.location.href = '/dashboard.html';
            }
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            errorDiv.style.display = 'none';

            var lastName = document.getElementById('lastName').value.trim();
            var firstName = document.getElementById('firstName').value.trim();
            var email = document.getElementById('email').value.trim();
            var phone = document.getElementById('phone').value.trim();
            var password = document.getElementById('password').value;
            var confirmPassword = document.getElementById('confirmPassword').value;
            var privacyOk = document.getElementById('consentPrivacy').checked;
            var emailOk = document.getElementById('consentEmail').checked;
            var marketingOk = document.getElementById('consentMarketing').checked;

            // Validation
            if (!lastName || !firstName) { showError('Please enter your full name.'); return; }
            if (!email) { showError('Please enter your email address.'); return; }
            if (!phone) { showError('Please enter your contact number.'); return; }
            if (!validatePassword(password)) {
                showError('Password must be at least 8 characters with letters, numbers, and a special character.');
                return;
            }
            if (password !== confirmPassword) { showError('Passwords do not match.'); return; }
            if (!privacyOk) { showError('You must agree to the personal information collection policy.'); return; }
            if (!emailOk) { showError('You must agree to the email collection policy.'); return; }
            if (!turnstileToken) { showError('Please complete the security verification.'); return; }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating account...';

            try {
                // 1. Create auth user in Supabase Auth
                var authResult = await sb.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            last_name: lastName,
                            first_name: firstName,
                            phone: phone
                        }
                    }
                });
                if (authResult.error) throw authResult.error;

                var user = authResult.data.user;
                if (!user) throw new Error('Failed to create account.');

                // 2. 세션 ID 생성 (단일 기기 로그인용)
                var sessionId = crypto.randomUUID();

                // 3. profiles 테이블에 저장
                var displayName = firstName + ' ' + lastName;
                var profileResult = await sb.from('profiles').upsert({
                    id: user.id,
                    email: email,
                    display_name: displayName,
                    phone: phone,
                    role: 'student',
                    is_active: true,
                    subscription_status: 'none',
                    active_session_id: sessionId,
                    last_active: new Date().toISOString(),
                    privacy_agreed: privacyOk,
                    email_collection_agreed: emailOk,
                    marketing_agreed: marketingOk
                });
                
                if (profileResult.error) {
                    console.warn('Profile save warning:', profileResult.error.message);
                }

                // 4. localStorage에 세션 ID 저장
                localStorage.setItem('ss_session_id', sessionId);

                // 5. 이메일 확인이 필요한지 체크
                if (authResult.data.session) {
                    // 이메일 확인 없이 바로 로그인됨 → 대시보드로 이동
                    window.location.href = '/dashboard.html';
                } else {
                    // 이메일 확인 필요
                    successDiv.innerHTML = '✅ Account created successfully!<br><br>Please check your email (<b>' + email + '</b>) to verify your account, then <a href="/login.html" style="color:#16a34a;font-weight:600;">log in here</a>.';
                    successDiv.style.display = 'block';
                    form.style.display = 'none';
                }

            } catch (err) {
                var errMsg = err.message || 'An error occurred. Please try again.';
                if (errMsg.includes('already registered')) {
                    errMsg = 'This email is already registered. Please log in or use a different email.';
                }
                showError(errMsg);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
                // Reset Turnstile
                if (window.turnstile) { turnstile.reset(); turnstileToken = null; }
            }
        });
    })();
    </script>
</body>
</html>
