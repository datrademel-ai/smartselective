<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Results ‚Äî SmartSelective</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Newsreader:opsz,wght@6..72,400;6..72,600;6..72,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #0f172a;
  --bg-primary: #1e293b;
  --bg-panel: #334155;
  --bg-hover: #475569;
  --accent: #6366f1;
  --green: #10b981;
  --green-bg: rgba(16,185,129,0.12);
  --red: #ef4444;
  --red-bg: rgba(239,68,68,0.1);
  --orange: #f59e0b;
  --orange-bg: rgba(245,158,11,0.12);
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border: rgba(255,255,255,0.08);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
}

.loading-screen {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--bg-deep);
  z-index: 1000;
}

.loading-screen.hidden { display: none; }

.loading-logo {
  font-family: 'Newsreader', serif;
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 1rem;
}

.loading-logo em { font-style: normal; color: var(--accent); }

.spinner {
  width: 32px; height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Header */
.header {
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  font-family: 'Newsreader', serif;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-primary);
  text-decoration: none;
}

.logo em { font-style: normal; color: var(--accent); }

.header-btn {
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  background: var(--accent);
  color: #fff;
  font-family: inherit;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  transition: all 0.2s;
}

.header-btn:hover { background: #4f46e5; }

/* Main Container */
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 32px 24px;
}

/* Score Card */
.score-card {
  background: linear-gradient(135deg, var(--bg-primary), var(--bg-panel));
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 40px;
  text-align: center;
  margin-bottom: 24px;
}

.score-badge {
  display: inline-block;
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 16px;
}

.score-badge.excellent { background: var(--green-bg); color: var(--green); }
.score-badge.good { background: var(--orange-bg); color: var(--orange); }
.score-badge.needs-work { background: var(--red-bg); color: var(--red); }

.score-ring {
  width: 160px;
  height: 160px;
  margin: 0 auto 20px;
  position: relative;
}

.score-ring svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.score-ring-bg {
  fill: none;
  stroke: var(--border);
  stroke-width: 10;
}

.score-ring-fill {
  fill: none;
  stroke: var(--accent);
  stroke-width: 10;
  stroke-linecap: round;
  transition: stroke-dashoffset 1s ease;
}

.score-ring-fill.excellent { stroke: var(--green); }
.score-ring-fill.good { stroke: var(--orange); }
.score-ring-fill.needs-work { stroke: var(--red); }

.score-value {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.score-percent {
  font-family: 'Newsreader', serif;
  font-size: 42px;
  font-weight: 700;
  line-height: 1;
}

.score-label {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 4px;
}

.test-title {
  font-family: 'Newsreader', serif;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 8px;
}

.test-meta {
  font-size: 14px;
  color: var(--text-secondary);
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 20px;
  text-align: center;
}

.stat-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 12px;
  color: var(--text-muted);
}

/* Questions Review */
.section-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.tab {
  padding: 8px 16px;
  border-radius: var(--radius-sm);
  background: var(--bg-primary);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.tab:hover { background: var(--bg-panel); color: var(--text-primary); }
.tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

.question-card {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 12px;
  overflow: hidden;
}

.question-header {
  padding: 16px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: background 0.2s;
}

.question-header:hover { background: var(--bg-panel); }

.question-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.q-num {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 700;
}

.q-num.correct { background: var(--green-bg); color: var(--green); }
.q-num.wrong { background: var(--red-bg); color: var(--red); }
.q-num.skipped { background: var(--orange-bg); color: var(--orange); }

.q-preview {
  font-size: 14px;
  color: var(--text-secondary);
  max-width: 500px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.q-status {
  font-size: 12px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 20px;
}

.q-status.correct { background: var(--green-bg); color: var(--green); }
.q-status.wrong { background: var(--red-bg); color: var(--red); }
.q-status.skipped { background: var(--orange-bg); color: var(--orange); }

.question-body {
  display: none;
  padding: 0 20px 20px;
  border-top: 1px solid var(--border);
}

.question-card.expanded .question-body { display: block; }
.question-card.expanded .question-header { background: var(--bg-panel); }

.q-passage {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  margin: 16px 0;
  font-size: 14px;
  line-height: 1.7;
  color: var(--text-secondary);
  max-height: 200px;
  overflow-y: auto;
}

.q-text {
  font-size: 15px;
  font-weight: 500;
  margin: 16px 0;
  line-height: 1.6;
}

.q-options {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin: 16px 0;
}

.q-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  font-size: 14px;
}

.q-option.correct-answer {
  background: var(--green-bg);
  border-color: rgba(16,185,129,0.3);
}

.q-option.user-wrong {
  background: var(--red-bg);
  border-color: rgba(239,68,68,0.3);
}

.q-option-letter {
  width: 24px;
  height: 24px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  background: var(--bg-panel);
  color: var(--text-muted);
}

.q-option.correct-answer .q-option-letter {
  background: var(--green);
  color: #fff;
}

.q-option.user-wrong .q-option-letter {
  background: var(--red);
  color: #fff;
}

.q-explanation {
  background: rgba(99,102,241,0.1);
  border: 1px solid rgba(99,102,241,0.2);
  border-radius: var(--radius-sm);
  padding: 16px;
  margin-top: 16px;
}

.q-explanation-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.q-explanation p {
  font-size: 14px;
  line-height: 1.6;
  color: var(--text-secondary);
}

/* Responsive */
@media (max-width: 768px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .container { padding: 20px 16px; }
  .score-card { padding: 24px; }
}
</style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">Smart<em>Selective</em></div>
  <div class="spinner"></div>
</div>

<div id="app" style="display:none">
  <!-- Header -->
  <header class="header">
    <a href="/dashboard.html" class="logo">Smart<em>Selective</em></a>
    <a href="/dashboard.html" class="header-btn">‚Üê Back to Dashboard</a>
  </header>

  <!-- Main Content -->
  <div class="container">
    <!-- Score Card -->
    <div class="score-card">
      <div class="score-badge" id="scoreBadge">Excellent!</div>
      <div class="score-ring">
        <svg viewBox="0 0 100 100">
          <circle class="score-ring-bg" cx="50" cy="50" r="42"></circle>
          <circle class="score-ring-fill" id="scoreRing" cx="50" cy="50" r="42" 
                  stroke-dasharray="264" stroke-dashoffset="264"></circle>
        </svg>
        <div class="score-value">
          <div class="score-percent" id="scorePercent">0%</div>
          <div class="score-label">Score</div>
        </div>
      </div>
      <div class="test-title" id="testTitle">Reading Comprehension</div>
      <div class="test-meta" id="testMeta">Completed on Feb 8, 2026</div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statCorrect" style="color:var(--green)">0</div>
        <div class="stat-label">Correct</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statWrong" style="color:var(--red)">0</div>
        <div class="stat-label">Wrong</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statSkipped" style="color:var(--orange)">0</div>
        <div class="stat-label">Skipped</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statTime">00:00</div>
        <div class="stat-label">Time Used</div>
      </div>
    </div>

    <!-- Questions Review -->
    <div class="section-title">üìã Question Review</div>
    <div class="tabs">
      <button class="tab active" data-filter="all">All</button>
      <button class="tab" data-filter="wrong">Wrong</button>
      <button class="tab" data-filter="correct">Correct</button>
      <button class="tab" data-filter="skipped">Skipped</button>
    </div>
    <div id="questionsList"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="shared.js"></script>
<script>
(function() {
'use strict';

var SS = window.SS_Shared;

var state = {
  attempt: null,
  test: null,
  questions: [],
  filter: 'all'
};

async function init() {
  var attemptId = SS.getUrlParam('attempt_id');
  if (!attemptId) {
    alert('No result specified.');
    window.location.href = '/dashboard.html';
    return;
  }

  // Check auth
  var user = await SS.requireAuth('/login.html');
  if (!user) return;

  // Load attempt
  state.attempt = await SS.dbLoadAttempt(attemptId);
  if (!state.attempt || state.attempt.user_id !== user.id) {
    alert('Result not found.');
    window.location.href = '/dashboard.html';
    return;
  }

  // Load test
  state.test = await SS.dbLoadTestById(state.attempt.test_id);

  // Load questions
  var rawQuestions = await SS.dbLoadQuestions(state.attempt.test_id);
  state.questions = rawQuestions.map(function(q) {
    return {
      id: q.id,
      passage: q.passage,
      question: q.question_text,
      options: [q.option_a, q.option_b, q.option_c, q.option_d],
      correctAnswer: q.correct_answer,
      explanation: q.explanation
    };
  });

  renderResults();

  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('app').style.display = 'block';
}

function renderResults() {
  var a = state.attempt;
  var answers = a.answers || {};
  var pct = a.score_percent || 0;

  // Score badge
  var badge = document.getElementById('scoreBadge');
  var ring = document.getElementById('scoreRing');
  if (pct >= 80) {
    badge.textContent = 'üéâ Excellent!';
    badge.className = 'score-badge excellent';
    ring.classList.add('excellent');
  } else if (pct >= 50) {
    badge.textContent = 'üëç Good Effort!';
    badge.className = 'score-badge good';
    ring.classList.add('good');
  } else {
    badge.textContent = 'üí™ Keep Practising!';
    badge.className = 'score-badge needs-work';
    ring.classList.add('needs-work');
  }

  // Score ring animation
  var circumference = 264;
  var offset = circumference - (pct / 100) * circumference;
  setTimeout(function() {
    ring.style.strokeDashoffset = offset;
  }, 100);

  document.getElementById('scorePercent').textContent = pct + '%';

  // Test title
  var subj = SS.SUBJ.find(function(s) { return s.id === state.test.subject; });
  document.getElementById('testTitle').textContent = (subj ? subj.icon + ' ' : '') + (subj ? subj.title : state.test.title);

  // Meta
  var completedDate = a.completed_at ? new Date(a.completed_at).toLocaleDateString('en-AU', {
    weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
  }) : '‚Äî';
  var status = a.status === 'timed_out' ? ' (Timed Out)' : '';
  document.getElementById('testMeta').textContent = 'Completed on ' + completedDate + status;

  // Stats
  var correct = a.score || 0;
  var total = state.questions.length;
  var skipped = 0;
  var wrong = 0;

  state.questions.forEach(function(q, i) {
    var userAns = answers[String(i)];
    if (userAns === undefined || userAns === null) {
      skipped++;
    } else if (userAns !== q.correctAnswer) {
      wrong++;
    }
  });

  document.getElementById('statCorrect').textContent = correct;
  document.getElementById('statWrong').textContent = wrong;
  document.getElementById('statSkipped').textContent = skipped;
  document.getElementById('statTime').textContent = SS.fmt(a.time_used_seconds || 0);

  // Questions list
  renderQuestions();

  // Tab handlers
  document.querySelectorAll('.tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      this.classList.add('active');
      state.filter = this.getAttribute('data-filter');
      renderQuestions();
    });
  });
}

function renderQuestions() {
  var answers = state.attempt.answers || {};
  var letters = ['A', 'B', 'C', 'D'];
  var html = '';

  state.questions.forEach(function(q, i) {
    var userAns = answers[String(i)];
    var isCorrect = userAns === q.correctAnswer;
    var isSkipped = userAns === undefined || userAns === null;
    var status = isSkipped ? 'skipped' : (isCorrect ? 'correct' : 'wrong');

    // Filter
    if (state.filter !== 'all' && state.filter !== status) return;

    var statusText = isSkipped ? 'Skipped' : (isCorrect ? 'Correct' : 'Wrong');

    html += '<div class="question-card" data-index="' + i + '">';
    html += '<div class="question-header" onclick="toggleQuestion(' + i + ')">';
    html += '<div class="question-info">';
    html += '<div class="q-num ' + status + '">' + (i + 1) + '</div>';
    html += '<div class="q-preview">' + SS.esc(q.question).substring(0, 80) + (q.question.length > 80 ? '...' : '') + '</div>';
    html += '</div>';
    html += '<div class="q-status ' + status + '">' + statusText + '</div>';
    html += '</div>';

    html += '<div class="question-body">';
    
    if (q.passage) {
      html += '<div class="q-passage">' + SS.esc(q.passage) + '</div>';
    }

    html += '<div class="q-text">' + SS.esc(q.question) + '</div>';

    html += '<div class="q-options">';
    q.options.forEach(function(opt, j) {
      var classes = 'q-option';
      if (j === q.correctAnswer) classes += ' correct-answer';
      if (j === userAns && !isCorrect) classes += ' user-wrong';

      var marker = '';
      if (j === q.correctAnswer) marker = ' ‚úì Correct';
      if (j === userAns && !isCorrect) marker = ' ‚úó Your answer';

      html += '<div class="' + classes + '">';
      html += '<div class="q-option-letter">' + letters[j] + '</div>';
      html += '<div>' + SS.esc(opt) + marker + '</div>';
      html += '</div>';
    });
    html += '</div>';

    if (q.explanation) {
      html += '<div class="q-explanation">';
      html += '<div class="q-explanation-title">üí° Explanation</div>';
      html += '<p>' + SS.esc(q.explanation) + '</p>';
      html += '</div>';
    }

    html += '</div>';
    html += '</div>';
  });

  if (!html) {
    html = '<div style="text-align:center;padding:40px;color:var(--text-muted)">No questions in this category.</div>';
  }

  document.getElementById('questionsList').innerHTML = html;
}

window.toggleQuestion = function(index) {
  var card = document.querySelector('.question-card[data-index="' + index + '"]');
  if (card) card.classList.toggle('expanded');
};

init();

})();
</script>

</body>
</html>
